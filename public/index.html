<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Tasks</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <style>
    :root {
      --bg-deep: #08090a;
      --bg-surface: #0d0e10;
      --bg-elevated: #131416;
      --bg-hover: #1a1b1e;
      --border: #1e2023;
      --text-primary: #e8e8e8;
      --text-secondary: #8b8d91;
      --text-tertiary: #5a5c60;
      --text-muted: #3d3f42;
      --accent: #E86F33;
      --accent-dim: rgba(232, 111, 51, 0.15);
      --accent-glow: rgba(232, 111, 51, 0.4);
      --success: #3ecf8e;
      --success-dim: rgba(62, 207, 142, 0.12);
      --warning: #f0b429;
      --warning-dim: rgba(240, 180, 41, 0.12);
      --mono: 'IBM Plex Mono', monospace;
      --serif: 'Playfair Display', serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--mono);
      font-size: 13px;
      background: var(--bg-deep);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* Subtle scan-line texture */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.03) 2px,
        rgba(0,0,0,0.03) 4px
      );
      pointer-events: none;
      z-index: 9999;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Layout */
    .app { display: flex; height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-mark svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    .logo-text {
      font-family: var(--serif);
      font-size: 16px;
      font-weight: 500;
      letter-spacing: -0.02em;
    }

    .connection {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .connection-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--warning);
    }

    .connection-dot.live {
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .connection-dot.error {
      background: #ef4444;
    }

    /* Sidebar sections */
    .sidebar-section {
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-section.flex-1 {
      flex: 1;
      border-bottom: none;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    .filter-row {
      display: flex;
      gap: 8px;
      padding: 0 12px 12px;
    }

    .filter-dropdown {
      flex: 1;
      appearance: none;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 6px 24px 6px 10px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%235a5c60' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .filter-dropdown option {
      background: var(--bg-surface);
      color: var(--text-primary);
    }

    .filter-dropdown:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Live Updates */
    .live-updates {
      padding: 0 12px 12px;
      max-height: 180px;
      overflow-y: auto;
    }

    .live-empty {
      padding: 16px;
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .live-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .live-item:hover {
      border-color: var(--text-muted);
    }

    .live-item .pulse {
      width: 8px;
      height: 8px;
      margin-top: 4px;
      background: var(--accent);
      border-radius: 50%;
      flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .live-item-content {
      flex: 1;
      min-width: 0;
    }

    .live-item-action {
      font-size: 12px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .live-item-session {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Sessions */
    .sessions-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 12px 12px;
    }

    .session-item {
      display: block;
      width: 100%;
      padding: 12px;
      margin-bottom: 4px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      text-align: left;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .session-item:hover {
      background: var(--bg-hover);
      border-color: var(--border);
    }

    .session-item.active {
      background: var(--bg-elevated);
      border-color: var(--border);
    }

    .session-name {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .session-name span {
      font-size: 13px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-name .pulse {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
      box-shadow: 0 0 12px var(--accent-glow);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }

    .session-secondary {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-progress {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .progress-bar {
      flex: 1;
      height: 2px;
      background: var(--border);
      border-radius: 1px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 10px;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    .session-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* Footer */
    .sidebar-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      font-size: 10px;
      color: var(--text-muted);
    }

    .sidebar-footer a {
      color: var(--text-tertiary);
      text-decoration: none;
      transition: color 0.15s;
    }

    .sidebar-footer a:hover {
      color: var(--text-secondary);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-deep);
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      opacity: 0.3;
    }

    .empty-state p {
      font-size: 13px;
    }

    /* Session view */
    .session-view {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .session-view.visible {
      display: flex;
    }

    /* Header */
    .view-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-surface);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .view-title {
      font-family: var(--serif);
      font-size: 20px;
      font-weight: 400;
      letter-spacing: -0.02em;
    }

    .view-meta {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .view-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .view-progress {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .view-progress .progress-bar {
      width: 120px;
      height: 3px;
    }

    .view-progress .progress-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--accent);
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .icon-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Kanban */
    .kanban {
      flex: 1;
      display: flex;
      gap: 24px;
      padding: 24px;
      overflow-x: auto;
    }

    .kanban-column {
      width: 320px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }

    .column-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .column-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .column-dot.pending { background: var(--text-muted); }
    .column-dot.in-progress {
      background: var(--accent);
      box-shadow: 0 0 12px var(--accent-glow);
      animation: pulse 2s ease-in-out infinite;
    }
    .column-dot.completed { background: var(--success); }

    .column-title {
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .column-title.pending { color: var(--text-tertiary); }
    .column-title.in-progress { color: var(--accent); }
    .column-title.completed { color: var(--success); }

    .column-count {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      font-variant-numeric: tabular-nums;
    }

    .column-count.pending {
      background: var(--bg-elevated);
      color: var(--text-muted);
    }

    .column-count.in-progress {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .column-count.completed {
      background: var(--success-dim);
      color: var(--success);
    }

    .column-tasks {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .column-empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Task card */
    .task-card {
      padding: 14px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .task-card:hover {
      background: var(--bg-elevated);
      border-color: var(--text-muted);
      transform: translateY(-1px);
    }

    .task-card.in-progress {
      border-color: var(--accent);
      box-shadow: 0 0 20px var(--accent-dim), inset 0 0 20px var(--accent-dim);
    }

    .task-card.completed {
      opacity: 0.6;
    }

    .task-card.blocked {
      opacity: 0.5;
    }

    .task-id {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .task-badge.blocked {
      background: var(--warning-dim);
      color: var(--warning);
    }

    .task-title {
      font-size: 13px;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .task-card.completed .task-title {
      text-decoration: line-through;
      color: var(--text-tertiary);
    }

    .task-session {
      font-size: 11px;
      color: var(--accent);
      margin-top: 6px;
      opacity: 0.8;
    }

    .task-active {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--accent);
    }

    .task-active::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    .task-blocked {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .task-desc {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Detail panel */
    .detail-panel {
      width: 400px;
      background: var(--bg-surface);
      border-left: 1px solid var(--border);
      display: none;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    .detail-panel.visible {
      display: flex;
    }

    .detail-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .detail-header h3 {
      font-family: var(--serif);
      font-size: 14px;
      font-weight: 500;
    }

    .detail-close {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s;
    }

    .detail-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .detail-close svg {
      width: 16px;
      height: 16px;
    }

    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-label {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .detail-title {
      font-family: var(--serif);
      font-size: 18px;
      line-height: 1.4;
    }

    .detail-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 4px;
    }

    .detail-status.pending {
      background: var(--bg-elevated);
      color: var(--text-tertiary);
    }

    .detail-status.in_progress {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .detail-status.completed {
      background: var(--success-dim);
      color: var(--success);
    }

    .detail-status .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .detail-status.in_progress .dot {
      animation: pulse 2s ease-in-out infinite;
    }

    .detail-box {
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
    }

    .detail-box.active {
      background: var(--accent-dim);
      border: 1px solid rgba(232, 111, 51, 0.2);
      color: var(--accent);
    }

    .detail-box.blocked {
      background: var(--warning-dim);
      border: 1px solid rgba(240, 180, 41, 0.2);
      color: var(--warning);
    }

    .detail-box.blocks {
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.2);
      color: #60a5fa;
    }

    .detail-desc {
      font-size: 13px;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .detail-desc pre {
      background: var(--bg-elevated);
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 12px 0;
      font-size: 12px;
    }

    .detail-desc code {
      background: var(--bg-elevated);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }

    .detail-desc pre code {
      background: transparent;
      padding: 0;
    }

    .detail-desc hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0;
    }

    .detail-desc h4 {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent);
      margin: 0 0 8px 0;
    }

    .detail-desc p {
      margin: 0 0 12px 0;
    }

    .detail-desc p:last-child {
      margin-bottom: 0;
    }

    /* Note form */
    .note-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .note-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .note-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.5;
      resize: vertical;
      min-height: 60px;
    }

    .note-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    .note-input::placeholder {
      color: var(--text-muted);
    }

    .note-submit {
      align-self: flex-end;
      padding: 8px 16px;
      background: var(--accent);
      border: none;
      border-radius: 5px;
      color: white;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .note-submit:hover {
      filter: brightness(1.1);
    }

    /* Light mode */
    body.light {
      --bg-deep: #fafafa;
      --bg-surface: #ffffff;
      --bg-elevated: #f5f5f5;
      --bg-hover: #efefef;
      --border: #e5e5e5;
      --text-primary: #171717;
      --text-secondary: #525252;
      --text-tertiary: #737373;
      --text-muted: #a3a3a3;
      --accent-dim: rgba(232, 111, 51, 0.1);
      --accent-glow: rgba(232, 111, 51, 0.3);
      --success-dim: rgba(62, 207, 142, 0.1);
      --warning-dim: rgba(240, 180, 41, 0.1);
    }

    body.light::before {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <header class="sidebar-header">
        <div class="logo">
          <div class="logo-mark">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <span class="logo-text">Claude Tasks</span>
        </div>
        <div id="connection-status" class="connection">
          <span class="connection-dot"></span>
          <span>Connecting</span>
        </div>
      </header>

      <!-- Live Updates -->
      <div class="sidebar-section">
        <div class="section-header">
          <span>Live Updates</span>
        </div>
        <div id="live-updates" class="live-updates">
          <div class="live-empty">No active tasks</div>
        </div>
      </div>

      <!-- Tasks -->
      <div class="sidebar-section flex-1">
        <div class="section-header">
          <span>Tasks</span>
        </div>
        <div class="filter-row">
          <select id="project-filter" class="filter-dropdown" onchange="filterByProject(this.value)">
            <option value="">All Projects</option>
          </select>
          <select id="session-filter" class="filter-dropdown" onchange="filterBySessions(this.value)">
            <option value="all">All Sessions</option>
            <option value="active">Active Only</option>
          </select>
        </div>
        <div id="sessions-list" class="sessions-list"></div>
      </div>

      <footer class="sidebar-footer">
        <a href="https://github.com/L1AD/claude-task-viewer" target="_blank">GitHub</a>
        <span style="margin: 0 6px;">·</span>
        <a href="https://policylayer.com" target="_blank">PolicyLayer</a>
      </footer>
    </aside>

    <!-- Main -->
    <main class="main">
      <div id="no-session" class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <p>Select a session to view tasks</p>
      </div>

      <div id="session-view" class="session-view">
        <header class="view-header">
          <div>
            <h1 id="session-title" class="view-title">Session</h1>
            <p id="session-meta" class="view-meta"></p>
          </div>
          <div class="view-actions">
            <div class="view-progress">
              <div class="progress-bar">
                <div id="progress-bar" class="progress-fill" style="width: 0%"></div>
              </div>
              <span id="progress-percent" class="progress-text">0%</span>
            </div>
            <button id="theme-toggle" class="icon-btn" onclick="toggleTheme()" title="Toggle theme">
              <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
              </svg>
              <svg id="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                <circle cx="12" cy="12" r="5"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
              </svg>
            </button>
          </div>
        </header>

        <div class="kanban">
          <div class="kanban-column">
            <div class="column-header">
              <span class="column-dot pending"></span>
              <span class="column-title pending">Pending</span>
              <span id="pending-count" class="column-count pending">0</span>
            </div>
            <div id="pending-tasks" class="column-tasks"></div>
          </div>

          <div class="kanban-column">
            <div class="column-header">
              <span class="column-dot in-progress"></span>
              <span class="column-title in-progress">In Progress</span>
              <span id="in-progress-count" class="column-count in-progress">0</span>
            </div>
            <div id="in-progress-tasks" class="column-tasks"></div>
          </div>

          <div class="kanban-column">
            <div class="column-header">
              <span class="column-dot completed"></span>
              <span class="column-title completed">Completed</span>
              <span id="completed-count" class="column-count completed">0</span>
            </div>
            <div id="completed-tasks" class="column-tasks"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Detail panel -->
    <aside id="detail-panel" class="detail-panel">
      <header class="detail-header">
        <h3>Task Details</h3>
        <button id="close-detail" class="detail-close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </header>
      <div id="detail-content" class="detail-content"></div>
    </aside>
  </div>

  <script>
    // State
    let sessions = [];
    let currentSessionId = null;
    let currentTasks = [];
    let viewMode = 'session';
    let sessionFilter = localStorage.getItem('sessionFilter') || 'all'; // 'all' or 'active'
    let filterProject = null; // null = all projects, or project path to filter

    // DOM
    const sessionsList = document.getElementById('sessions-list');
    const noSession = document.getElementById('no-session');
    const sessionView = document.getElementById('session-view');
    const sessionTitle = document.getElementById('session-title');
    const sessionMeta = document.getElementById('session-meta');
    const progressPercent = document.getElementById('progress-percent');
    const progressBar = document.getElementById('progress-bar');
    const pendingTasks = document.getElementById('pending-tasks');
    const inProgressTasks = document.getElementById('in-progress-tasks');
    const completedTasks = document.getElementById('completed-tasks');
    const pendingCount = document.getElementById('pending-count');
    const inProgressCount = document.getElementById('in-progress-count');
    const completedCount = document.getElementById('completed-count');
    const detailPanel = document.getElementById('detail-panel');
    const detailContent = document.getElementById('detail-content');
    const connectionStatus = document.getElementById('connection-status');

    async function fetchSessions() {
      try {
        const res = await fetch('/api/sessions');
        sessions = await res.json();
        renderSessions();
        fetchLiveUpdates();
      } catch (error) {
        console.error('Failed to fetch sessions:', error);
      }
    }

    async function fetchLiveUpdates() {
      try {
        const res = await fetch('/api/tasks/all');
        const allTasks = await res.json();
        let activeTasks = allTasks.filter(t => t.status === 'in_progress');
        if (filterProject) {
          activeTasks = activeTasks.filter(t => t.project === filterProject);
        }
        renderLiveUpdates(activeTasks);
      } catch (error) {
        console.error('Failed to fetch live updates:', error);
      }
    }

    function renderLiveUpdates(activeTasks) {
      const container = document.getElementById('live-updates');

      if (activeTasks.length === 0) {
        container.innerHTML = '<div class="live-empty">No active tasks</div>';
        return;
      }

      container.innerHTML = activeTasks.map(task => `
        <div class="live-item" onclick="openLiveTask('${task.sessionId}', '${task.id}')">
          <span class="pulse"></span>
          <div class="live-item-content">
            <div class="live-item-action">${escapeHtml(task.activeForm || task.subject)}</div>
            <div class="live-item-session">${escapeHtml(task.sessionName || task.sessionId.slice(0, 8))}</div>
          </div>
        </div>
      `).join('');
    }

    async function openLiveTask(sessionId, taskId) {
      await fetchTasks(sessionId);
      showTaskDetail(taskId, sessionId);
    }

    async function fetchTasks(sessionId) {
      try {
        viewMode = 'session';
        const res = await fetch(`/api/sessions/${sessionId}`);
        currentTasks = await res.json();
        currentSessionId = sessionId;
        renderSession();
      } catch (error) {
        console.error('Failed to fetch tasks:', error);
      }
    }

    async function showAllTasks() {
      try {
        viewMode = 'all';
        currentSessionId = null;
        const res = await fetch('/api/tasks/all');
        let tasks = await res.json();
        if (filterProject) {
          tasks = tasks.filter(t => t.project === filterProject);
        }
        currentTasks = tasks;
        renderAllTasks();
        renderSessions();
      } catch (error) {
        console.error('Failed to fetch all tasks:', error);
      }
    }

    function renderAllTasks() {
      noSession.style.display = 'none';
      sessionView.classList.add('visible');

      const totalTasks = currentTasks.length;
      const completed = currentTasks.filter(t => t.status === 'completed').length;
      const percent = totalTasks > 0 ? Math.round((completed / totalTasks) * 100) : 0;

      const projectName = filterProject ? filterProject.split('/').pop() : null;
      sessionTitle.textContent = filterProject ? `Tasks: ${projectName}` : 'All Tasks';
      sessionMeta.textContent = filterProject
        ? `${totalTasks} tasks in this project`
        : `${totalTasks} tasks across ${sessions.length} sessions`;
      progressPercent.textContent = `${percent}%`;
      progressBar.style.width = `${percent}%`;

      renderKanban();
    }

    function renderSessions() {
      // Update project dropdown
      updateProjectDropdown();

      let filteredSessions = sessions;
      if (sessionFilter === 'active') {
        filteredSessions = filteredSessions.filter(s => s.pending > 0 || s.inProgress > 0);
      }
      if (filterProject) {
        filteredSessions = filteredSessions.filter(s => s.project === filterProject);
      }

      if (filteredSessions.length === 0) {
        let emptyMsg = 'No sessions found';
        let emptyHint = 'Tasks appear when you use Claude Code';
        if (filterProject && sessionFilter === 'active') {
          emptyMsg = 'No active sessions for this project';
          emptyHint = 'Try "All Sessions" or "All Projects"';
        } else if (filterProject) {
          emptyMsg = 'No sessions for this project';
          emptyHint = 'Select "All Projects" to see all';
        } else if (sessionFilter === 'active') {
          emptyMsg = 'No active sessions';
          emptyHint = 'Select "All Sessions" to see all';
        }
        sessionsList.innerHTML = `
          <div style="padding: 24px 12px; text-align: center; color: var(--text-muted); font-size: 12px;">
            <p>${emptyMsg}</p>
            <p style="margin-top: 8px; font-size: 11px;">${emptyHint}</p>
          </div>
        `;
        return;
      }

      sessionsList.innerHTML = filteredSessions.map(session => {
        const total = session.taskCount;
        const percent = total > 0 ? Math.round((session.completed / total) * 100) : 0;
        const isActive = session.id === currentSessionId && viewMode === 'session';
        const hasInProgress = session.inProgress > 0;
        const sessionName = session.name || session.id.slice(0, 8) + '...';
        const projectName = session.project ? session.project.split('/').pop() : null;
        const primaryName = projectName || sessionName;
        const secondaryName = projectName ? sessionName : null;

        return `
          <button onclick="fetchTasks('${session.id}')" class="session-item ${isActive ? 'active' : ''}">
            <div class="session-name">
              <span>${escapeHtml(primaryName)}</span>
              ${hasInProgress ? '<span class="pulse"></span>' : ''}
            </div>
            ${secondaryName ? `<div class="session-secondary">${escapeHtml(secondaryName)}</div>` : ''}
            <div class="session-progress">
              <div class="progress-bar"><div class="progress-fill" style="width: ${percent}%"></div></div>
              <span class="progress-text">${session.completed}/${total}</span>
            </div>
            <div class="session-time">${formatDate(session.modifiedAt)}</div>
          </button>
        `;
      }).join('');
    }

    function renderSession() {
      noSession.style.display = 'none';
      sessionView.classList.add('visible');

      const session = sessions.find(s => s.id === currentSessionId);
      if (!session) return;

      const displayName = session.name || currentSessionId;
      sessionTitle.textContent = displayName;
      const projectName = session.project ? session.project.split('/').pop() : null;
      sessionMeta.textContent = `${currentTasks.length} tasks${projectName ? ' · ' + projectName : ''} · ${formatDate(session.modifiedAt)}`;

      const completed = currentTasks.filter(t => t.status === 'completed').length;
      const percent = currentTasks.length > 0 ? Math.round((completed / currentTasks.length) * 100) : 0;

      progressPercent.textContent = `${percent}%`;
      progressBar.style.width = `${percent}%`;

      renderKanban();
      renderSessions();
    }

    function renderTaskCard(task) {
      const isBlocked = task.blockedBy && task.blockedBy.length > 0;
      const taskId = viewMode === 'all' ? `${task.sessionId?.slice(0,4)}-${task.id}` : task.id;
      const sessionLabel = viewMode === 'all' && task.sessionName ? task.sessionName : null;
      const statusClass = task.status.replace('_', '-');

      return `
        <div onclick="showTaskDetail('${task.id}', '${task.sessionId || ''}')" class="task-card ${statusClass} ${isBlocked ? 'blocked' : ''}">
          <div class="task-id">
            <span>#${taskId}</span>
            ${isBlocked ? '<span class="task-badge blocked">Blocked</span>' : ''}
          </div>
          <div class="task-title">${escapeHtml(task.subject)}</div>
          ${sessionLabel ? `<div class="task-session">${escapeHtml(sessionLabel)}</div>` : ''}
          ${task.status === 'in_progress' && task.activeForm ? `<div class="task-active">${escapeHtml(task.activeForm)}</div>` : ''}
          ${isBlocked ? `<div class="task-blocked">Waiting on ${task.blockedBy.map(id => '#' + id).join(', ')}</div>` : ''}
          ${task.description ? `<div class="task-desc">${escapeHtml(task.description.split('\n')[0])}</div>` : ''}
        </div>
      `;
    }

    function renderKanban() {
      const pending = currentTasks.filter(t => t.status === 'pending');
      const inProgress = currentTasks.filter(t => t.status === 'in_progress');
      const completed = currentTasks.filter(t => t.status === 'completed');

      pendingCount.textContent = pending.length;
      inProgressCount.textContent = inProgress.length;
      completedCount.textContent = completed.length;

      pendingTasks.innerHTML = pending.length > 0
        ? pending.map(renderTaskCard).join('')
        : '<div class="column-empty">No pending tasks</div>';

      inProgressTasks.innerHTML = inProgress.length > 0
        ? inProgress.map(renderTaskCard).join('')
        : '<div class="column-empty">No active tasks</div>';

      completedTasks.innerHTML = completed.length > 0
        ? completed.map(renderTaskCard).join('')
        : '<div class="column-empty">No completed tasks</div>';
    }

    function showTaskDetail(taskId, sessionId = null) {
      const task = currentTasks.find(t => t.id === taskId && (!sessionId || t.sessionId === sessionId));
      if (!task) return;

      detailPanel.classList.add('visible');

      const statusLabels = {
        completed: '<span class="detail-status completed"><span class="dot"></span>Completed</span>',
        in_progress: '<span class="detail-status in_progress"><span class="dot"></span>In Progress</span>',
        pending: '<span class="detail-status pending"><span class="dot"></span>Pending</span>'
      };

      detailContent.innerHTML = `
        <div class="detail-section">
          <div class="detail-label">Task #${task.id}</div>
          <h2 class="detail-title">${escapeHtml(task.subject)}</h2>
        </div>

        <div class="detail-section">
          ${statusLabels[task.status] || statusLabels.pending}
        </div>

        ${task.activeForm && task.status === 'in_progress' ? `
          <div class="detail-section">
            <div class="detail-box active">
              <strong>Currently:</strong> ${escapeHtml(task.activeForm)}
            </div>
          </div>
        ` : ''}

        ${task.blockedBy && task.blockedBy.length > 0 ? `
          <div class="detail-section">
            <div class="detail-box blocked">
              <strong>Blocked by:</strong> ${task.blockedBy.map(id => '#' + id).join(', ')}
            </div>
          </div>
        ` : ''}

        ${task.blocks && task.blocks.length > 0 ? `
          <div class="detail-section">
            <div class="detail-box blocks">
              <strong>Blocks:</strong> ${task.blocks.map(id => '#' + id).join(', ')}
            </div>
          </div>
        ` : ''}

        ${task.description ? `
          <div class="detail-section">
            <div class="detail-label">Description</div>
            <div class="detail-desc">${DOMPurify.sanitize(marked.parse(task.description))}</div>
          </div>
        ` : ''}

        <div class="detail-section note-section">
          <div class="detail-label">Add Note</div>
          <form class="note-form" onsubmit="addNote(event, '${task.id}', '${task.sessionId || currentSessionId}')">
            <textarea id="note-input" class="note-input" placeholder="Add a note for Claude..." rows="3"></textarea>
            <button type="submit" class="note-submit">Add Note</button>
          </form>
        </div>
      `;
    }

    async function addNote(event, taskId, sessionId) {
      event.preventDefault();
      const input = document.getElementById('note-input');
      const note = input.value.trim();
      if (!note) return;

      try {
        const res = await fetch(`/api/tasks/${sessionId}/${taskId}/note`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note })
        });

        if (res.ok) {
          input.value = '';
          // Refresh to show updated description
          if (viewMode === 'all') {
            const tasksRes = await fetch('/api/tasks/all');
            currentTasks = await tasksRes.json();
          } else {
            await fetchTasks(sessionId);
          }
          showTaskDetail(taskId, sessionId);
        }
      } catch (error) {
        console.error('Failed to add note:', error);
      }
    }

    function closeDetailPanel() {
      detailPanel.classList.remove('visible');
    }

    document.getElementById('close-detail').onclick = closeDetailPanel;

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && detailPanel.classList.contains('visible')) {
        closeDetailPanel();
      }
    });

    function setupEventSource() {
      let retryDelay = 1000;
      let eventSource;

      function connect() {
        eventSource = new EventSource('/api/events');

        eventSource.onopen = () => {
          retryDelay = 1000; // Reset on successful connection
          connectionStatus.innerHTML = `
            <span class="connection-dot live"></span>
            <span>Connected</span>
          `;
        };

        eventSource.onerror = () => {
          eventSource.close();
          connectionStatus.innerHTML = `
            <span class="connection-dot error"></span>
            <span>Reconnecting...</span>
          `;
          setTimeout(connect, retryDelay);
          retryDelay = Math.min(retryDelay * 2, 30000); // Max 30s
        };

        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'update' || data.type === 'metadata-update') {
            fetchSessions();
            if (currentSessionId && data.sessionId === currentSessionId) {
              fetchTasks(currentSessionId);
            }
          }
        };
      }

      connect();
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      return date.toLocaleDateString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function filterBySessions(value) {
      sessionFilter = value;
      localStorage.setItem('sessionFilter', sessionFilter);
      renderSessions();
    }

    function filterByProject(project) {
      filterProject = project || null;
      renderSessions();
      fetchLiveUpdates();
      showAllTasks();
    }

    function updateProjectDropdown() {
      const dropdown = document.getElementById('project-filter');
      const projects = [...new Set(sessions.map(s => s.project).filter(Boolean))].sort();

      dropdown.innerHTML = '<option value="">All Projects</option>' +
        projects.map(p => {
          const name = p.split('/').pop();
          const selected = p === filterProject ? ' selected' : '';
          return `<option value="${p}"${selected} title="${escapeHtml(p)}">${escapeHtml(name)}</option>`;
        }).join('');
    }

    function toggleTheme() {
      const isLight = document.body.classList.toggle('light');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
      document.getElementById('theme-icon-dark').style.display = isLight ? 'none' : 'block';
      document.getElementById('theme-icon-light').style.display = isLight ? 'block' : 'none';
    }

    function loadTheme() {
      if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light');
        document.getElementById('theme-icon-dark').style.display = 'none';
        document.getElementById('theme-icon-light').style.display = 'block';
      }
    }

    function loadPreferences() {
      document.getElementById('session-filter').value = sessionFilter;
    }

    // Init
    loadTheme();
    loadPreferences();
    fetchSessions();
    setupEventSource();
    setTimeout(showAllTasks, 500);
  </script>
</body>
</html>
