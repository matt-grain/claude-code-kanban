<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CC Kanban</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%231a1a1a'/%3E%3Crect x='4' y='6' width='7' height='20' rx='2' fill='%23e8927c'/%3E%3Crect x='13' y='6' width='7' height='14' rx='2' fill='%23e8927c'/%3E%3Crect x='22' y='6' width='7' height='8' rx='2' fill='%23e8927c'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    @font-face { font-display: swap; }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <style>
    :root {
      --bg-deep: #101114;
      --bg-surface: #16181c;
      --bg-elevated: #1e2025;
      --bg-hover: #282a30;
      --border: #363840;
      --text-primary: #f0f1f3;
      --text-secondary: #c2c4c9;
      --text-tertiary: #9a9da5;
      --text-muted: #7d808a;
      --accent: #E86F33;
      --accent-dim: rgba(232, 111, 51, 0.22);
      --accent-glow: rgba(232, 111, 51, 0.55);
      --success: #3ecf8e;
      --success-dim: rgba(62, 207, 142, 0.18);
      --warning: #f0b429;
      --warning-dim: rgba(240, 180, 41, 0.18);
      --team: #60a5fa;
      --team-dim: rgba(96, 165, 250, 0.18);
      --mono: 'IBM Plex Mono', monospace;
      --serif: 'Playfair Display', serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--mono);
      font-size: 14px;
      background: var(--bg-deep);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* Subtle scan-line texture */
    body::before {
      display: none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Layout */
    .app { display: flex; height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width, 300px);
      background: var(--bg-surface);
      border-right: 1px solid var(--border);
      box-shadow: 1px 0 12px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      transition: width 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar.collapsed { width: 48px; }
    .sidebar.collapsed .logo-text,
    .sidebar.collapsed .connection,
    .sidebar.collapsed .sidebar-section,
    .sidebar.collapsed .sidebar-footer { display: none; }
    .sidebar.collapsed .sidebar-header {
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .sidebar.collapsed .sidebar-toggle-btn {
      position: static;
    }
    .sidebar.resizing { transition: none; }

    .sidebar-header {
      padding: 20px 20px 16px;
      border-bottom: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
      position: relative;
    }

    .sidebar-toggle-btn {
      position: absolute;
      top: 20px;
      right: 8px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
      padding: 0;
    }

    .sidebar-toggle-btn:hover {
      color: var(--text-secondary);
      background: var(--bg-hover);
      border-color: var(--border);
    }

    .sidebar-toggle-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.25s ease;
    }

    .sidebar.collapsed .sidebar-toggle-btn svg {
      transform: rotate(180deg);
    }

    .sidebar-resize-handle {
      position: absolute;
      top: 0;
      right: 0;
      width: 4px;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      transition: background 0.15s;
    }

    .sidebar-resize-handle:hover,
    .sidebar-resize-handle.dragging {
      background: var(--accent-dim);
    }

    .sidebar.collapsed .sidebar-resize-handle { display: none; }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-mark svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    .logo-text {
      font-family: var(--serif);
      font-size: 17px;
      font-weight: 500;
      letter-spacing: -0.02em;
    }

    .connection {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .connection-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--warning);
    }

    .connection-dot.live {
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .connection-dot.error {
      background: #ef4444;
    }

    /* Sidebar sections */
    .sidebar-section {
      display: flex;
      flex-direction: column;
      border-bottom: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
    }

    .sidebar-section.flex-1 {
      flex: 1;
      border-bottom: none;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px 10px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .filter-row {
      display: flex;
      gap: 6px;
      padding: 0 16px 10px;
    }

    .reset-btn {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
    }

    .filter-dropdown {
      flex: 1;
      appearance: none;
      background: var(--bg-deep);
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 7px 26px 7px 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%238b8d95' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      text-overflow: ellipsis;
      min-width: 0;
      transition: all 0.15s ease;
    }

    .filter-dropdown:hover {
      border-color: var(--border);
    }

    .filter-dropdown option {
      background: var(--bg-surface);
      color: var(--text-primary);
    }

    .filter-dropdown:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    /* Live Updates */
    .live-updates {
      padding: 0 16px 12px;
      max-height: 180px;
      overflow-y: auto;
    }

    .live-empty {
      padding: 16px;
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .live-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-deep);
      border: 1px solid transparent;
      border-radius: 8px;
      margin-bottom: 4px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .live-item:hover {
      background: var(--bg-hover);
    }

    .live-item .pulse {
      width: 8px;
      height: 8px;
      margin-top: 4px;
      background: var(--accent);
      border-radius: 50%;
      flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .live-item-content {
      flex: 1;
      min-width: 0;
    }

    .live-item-action {
      font-size: 13px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .live-item-session {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Sessions */
    .sessions-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 14px 12px;
    }

    .session-item {
      display: block;
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 2px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .session-item:hover {
      background: var(--bg-hover);
    }

    .session-item.active {
      background: var(--bg-elevated);
      border-color: var(--border);
    }

    .session-name {
      font-size: 14px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-indicators .pulse {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
      box-shadow: 0 0 12px var(--accent-glow);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.9); }
    }

    .session-secondary {
      font-size: 12px;
      font-weight: 450;
      color: var(--text-tertiary);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
    }

    .session-branch {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
      display: block;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.7;
    }

    .session-progress {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .progress-bar {
      flex: 1;
      height: 2px;
      background: var(--border);
      border-radius: 1px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.5s ease-out;
    }

    .progress-text {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-tertiary);
      font-variant-numeric: tabular-nums;
    }

    .session-time {
      font-size: 11px;
      font-weight: 450;
      color: var(--text-tertiary);
      margin-top: 6px;
    }

    /* Footer */
    .sidebar-footer {
      padding: 14px 20px;
      border-top: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: top;
      font-size: 10px;
      color: var(--text-muted);
    }

    .sidebar-footer a {
      color: var(--text-tertiary);
      text-decoration: none;
      transition: color 0.15s;
    }

    .sidebar-footer a:hover {
      color: var(--text-secondary);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-deep);
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 13px;
    }

    /* Session view */
    .session-view {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .session-view.visible {
      display: flex;
    }

    /* Header */
    .view-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-surface);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .view-title {
      font-family: var(--serif);
      font-size: 26px;
      font-weight: 400;
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .view-meta {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .view-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .view-progress {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .view-progress .progress-bar {
      width: 120px;
      height: 3px;
    }

    .view-progress .progress-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--accent);
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .icon-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    .icon-btn-danger {
      color: #ef4444;
    }

    .icon-btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border-color: #ef4444;
    }

    /* Kanban */
    .kanban {
      flex: 1;
      display: flex;
      gap: 24px;
      padding: 24px;
      overflow-x: auto;
    }

    .kanban-column {
      flex: 1;
      min-width: 280px;
      max-width: 400px;
      display: flex;
      flex-direction: column;
    }

    .column-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 20px;
      border-bottom: none;
      margin-bottom: 16px;
      background-image: linear-gradient(to bottom, transparent 80%, var(--border) 100%);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
    }

    .column-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .column-dot.pending { background: var(--text-tertiary); }
    .column-dot.in-progress {
      background: var(--accent);
      box-shadow: 0 0 12px var(--accent-glow);
      animation: pulse 2s ease-in-out infinite;
    }
    .column-dot.completed { background: var(--success); }

    .column-title {
      font-size: 14px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .column-title.pending { color: var(--text-tertiary); }
    .column-title.in-progress { color: var(--accent); }
    .column-title.completed { color: var(--success); }

    .column-count {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-variant-numeric: tabular-nums;
    }

    .column-count.pending {
      background: var(--bg-elevated);
      color: var(--text-tertiary);
    }

    .column-count.in-progress {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .column-count.completed {
      background: var(--success-dim);
      color: var(--success);
    }

    .column-tasks {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 8px;
    }

    .column-empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
      font-size: 12px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      margin-top: 4px;
    }

    .column-empty svg {
      width: 24px;
      height: 24px;
      opacity: 0.5;
      margin-bottom: 8px;
    }

    /* Task card */
    .task-card {
      padding: 16px;
      padding-left: 18px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-left: 2px solid var(--text-muted);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-card:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
      border-left-color: var(--text-muted);
    }

    .task-card:focus-visible {
      outline: none;
    }

    .task-card.in-progress {
      border-left: 2px solid var(--accent);
    }

    .task-card.completed {
      opacity: 0.85;
      border-left: 2px solid var(--success);
    }

    .task-card.completed:hover {
      border-left-color: var(--success);
    }

    .task-card.blocked {
      opacity: 0.7;
    }

    .task-card.selected,
    .task-card.selected:hover {
      background: var(--bg-elevated);
      border-color: var(--team);
      border-left: 2px solid var(--team);
      box-shadow: 0 0 0 1px var(--team-dim), 0 0 12px var(--team-dim);
      opacity: 1;
    }

    .task-id {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .task-badge.blocked {
      background: rgba(220, 80, 30, 0.15);
      color: #dc4e1e;
    }

    .task-title {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .task-card.completed .task-title {
      text-decoration: line-through;
      color: var(--text-tertiary);
    }

    .task-session {
      font-size: 12px;
      color: var(--accent);
      margin-top: 6px;
    }

    .task-active {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 11px;
      font-weight: 500;
      color: var(--accent);
    }

    .task-active::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    .task-blocked {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .task-desc {
      font-size: 12px;
      font-weight: 450;
      color: var(--text-tertiary);
      margin-top: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Detail panel */
    .detail-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 440px;
      height: 100vh;
      background: var(--bg-surface);
      border-left: 1px solid var(--border);
      box-shadow: -8px 0 24px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      display: none;
      z-index: 100;
      overflow: hidden;
    }

    .detail-panel.visible {
      display: flex;
    }

    .detail-header {
      padding: 16px 20px;
      border-bottom: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .detail-header h3 {
      font-family: var(--serif);
      font-size: 14px;
      font-weight: 500;
    }

    .detail-close {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s;
    }

    .detail-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .detail-close svg {
      width: 16px;
      height: 16px;
    }

    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .detail-section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
    }

    .detail-section:last-child {
      background-image: none;
    }

    .detail-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .detail-title {
      font-family: var(--serif);
      font-size: 22px;
      line-height: 1.4;
    }

    .detail-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .detail-status.pending {
      background: var(--bg-elevated);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .detail-status.in_progress {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .detail-status.completed {
      background: var(--success-dim);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .detail-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .detail-status.in_progress .dot {
      animation: pulse 2s ease-in-out infinite;
    }

    .detail-box {
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
    }

    .detail-box.active {
      background: rgba(232, 111, 51, 0.08);
      border: 1px solid rgba(232, 111, 51, 0.2);
      color: var(--text-primary);
    }

    .detail-box.active strong {
      color: var(--accent);
    }

    .detail-box.blocked {
      background: var(--warning-dim);
      border: 1px solid rgba(240, 180, 41, 0.35);
      color: var(--warning);
    }

    .detail-box.blocks {
      background: var(--team-dim);
      border: 1px solid rgba(96, 165, 250, 0.35);
      color: var(--team);
    }

    .detail-desc {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .detail-desc pre {
      background: var(--bg-elevated);
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 12px 0;
      font-size: 12px;
    }

    .detail-desc code {
      background: var(--bg-elevated);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }

    .detail-desc pre code {
      background: transparent;
      padding: 0;
    }

    .detail-desc hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0;
    }

    .detail-desc h4 {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent);
      margin: 0 0 8px 0;
    }

    .detail-desc p {
      margin: 0 0 12px 0;
    }

    .detail-desc p:last-child {
      margin-bottom: 0;
    }

    .detail-desc ol,
    .detail-desc ul {
      padding-left: 1.5em;
      margin: 0 0 12px 0;
    }

    .detail-desc ol:last-child,
    .detail-desc ul:last-child {
      margin-bottom: 0;
    }

    /* Note form */
    .note-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .note-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .note-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.5;
      resize: vertical;
      min-height: 60px;
    }

    .note-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    .note-input::placeholder {
      color: var(--text-muted);
    }

    .note-submit {
      align-self: flex-end;
      padding: 8px 16px;
      background: var(--accent);
      border: none;
      border-radius: 5px;
      color: white;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .note-submit:hover {
      filter: brightness(1.1);
    }

    /* Team badge */
    .session-indicators {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .team-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .team-badge .member-count {
      font-weight: 600;
    }

    .team-info-btn {
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background: var(--bg-deep);
      border: 1px solid transparent;
      border-radius: 4px;
      color: var(--team);
      cursor: pointer;
      font-size: 11px;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .team-info-btn:hover {
      background: var(--team-dim);
      border-color: var(--team);
    }

    /* Task owner badge */
    .task-owner-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: none;
      letter-spacing: 0;
    }

    /* Team modal member card */
    .team-member-card {
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .team-member-card .member-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .team-member-card .member-detail {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .team-member-card .member-tasks {
      font-size: 11px;
      color: var(--accent);
      margin-top: 4px;
    }

    .team-modal-desc {
      font-size: 12px;
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: 16px;
    }

    .team-modal-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    /* Owner filter â€” overlaid, zero layout impact */
    .kanban {
      position: relative;
    }

    .owner-filter-bar {
      display: none;
      position: absolute;
      top: 24px;
      right: 24px;
      z-index: 2;
    }

    .owner-filter-bar.visible {
      display: flex;
      align-items: center;
    }

    .owner-filter-bar .filter-dropdown {
      flex: none;
      width: auto;
      max-width: 180px;
      font-size: 13px;
      padding: 6px 10px;
    }

    /* Light mode */
    body.light {
      --bg-deep: #e8e6e3;
      --bg-surface: #f4f3f1;
      --bg-elevated: #dddbd8;
      --bg-hover: #d2d0cc;
      --border: #a09b94;
      --text-primary: #0a0a0a;
      --text-secondary: #444444;
      --text-tertiary: #666666;
      --text-muted: #888888;
      --accent-dim: rgba(232, 111, 51, 0.18);
      --accent-glow: rgba(232, 111, 51, 0.5);
      --success: #1a8a5a;
      --success-dim: rgba(26, 138, 90, 0.15);
      --warning: #b07d0a;
      --warning-dim: rgba(176, 125, 10, 0.15);
    }

    body.light::before {
      display: none;
    }

    /* Interactive elements */
    .icon-btn.delete:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    .column-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .column-header .icon-btn {
      width: 28px;
      height: 28px;
    }

    .column-header .icon-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Search input */
    .search-container {
      position: relative;
      padding: 0 16px 8px;
    }

    .search-input {
      width: 100%;
      padding: 9px 32px 9px 12px;
      background: var(--bg-deep);
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 13px;
      transition: all 0.15s ease;
    }

    .search-input:hover {
      border-color: var(--border);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-clear {
      position: absolute;
      right: 18px;
      top: 8px;
      width: 20px;
      height: 20px;
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0;
      border-radius: 3px;
    }

    .search-clear:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .search-clear.visible {
      display: flex;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.15s ease;
    }

    .modal-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .modal-body {
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 14px;
      transition: all 0.15s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    textarea.form-input {
      resize: vertical;
      min-height: 80px;
      font-family: var(--mono);
    }

    select.form-input[multiple] {
      padding: 4px;
    }

    select.form-input optgroup {
      background: var(--bg-surface);
      color: var(--accent);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 8px 8px 4px 8px;
      margin-top: 4px;
      font-style: normal;
    }

    select.form-input optgroup:first-child {
      margin-top: 0;
    }

    select.form-input option {
      padding: 8px 8px 8px 16px;
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-weight: 400;
      font-size: 13px;
      border-radius: 4px;
      margin: 2px 4px;
    }

    select.form-input option:checked {
      background: var(--accent);
      color: var(--bg-deep);
      font-weight: 500;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #d96329;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
    }

    /* Skip navigation */
    .skip-link {
      position: absolute;
      top: -100%;
      left: 16px;
      z-index: 100000;
      padding: 8px 16px;
      background: var(--accent);
      color: white;
      font-size: 13px;
      border-radius: 0 0 6px 6px;
      text-decoration: none;
      transition: top 0.2s;
    }

    .skip-link:focus {
      top: 0;
    }

    /* Visually hidden (a11y) */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* System theme detection */
    @media (prefers-color-scheme: light) {
      body:not(.dark-forced) {
        --bg-deep: #e8e6e3;
        --bg-surface: #f4f3f1;
        --bg-elevated: #dddbd8;
        --bg-hover: #d2d0cc;
        --border: #a09b94;
        --text-primary: #0a0a0a;
        --text-secondary: #444444;
        --text-tertiary: #666666;
        --text-muted: #888888;
        --accent-dim: rgba(232, 111, 51, 0.18);
        --accent-glow: rgba(232, 111, 51, 0.5);
        --success: #1a8a5a;
        --success-dim: rgba(26, 138, 90, 0.15);
        --warning: #b07d0a;
        --warning-dim: rgba(176, 125, 10, 0.15);
      }

      body:not(.dark-forced)::before {
        display: none;
      }
    }

    /* Card entrance animation */
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .column-tasks .task-card {
      animation: fadeSlideIn 150ms ease-out both;
    }

    .column-tasks .task-card:nth-child(1) { animation-delay: 0ms; }
    .column-tasks .task-card:nth-child(2) { animation-delay: 30ms; }
    .column-tasks .task-card:nth-child(3) { animation-delay: 60ms; }
    .column-tasks .task-card:nth-child(4) { animation-delay: 90ms; }
    .column-tasks .task-card:nth-child(5) { animation-delay: 120ms; }
    .column-tasks .task-card:nth-child(6) { animation-delay: 150ms; }
    .column-tasks .task-card:nth-child(7) { animation-delay: 180ms; }
    .column-tasks .task-card:nth-child(8) { animation-delay: 210ms; }
    .column-tasks .task-card:nth-child(9) { animation-delay: 240ms; }
    .column-tasks .task-card:nth-child(10) { animation-delay: 270ms; }

    /* Connection status breathing */
    @keyframes breathe {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.65; }
    }

    .connection-dot.live {
      animation: breathe 3s ease-in-out infinite;
    }

    /* Progress bar shimmer */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .progress-fill.shimmer {
      background: linear-gradient(90deg, var(--accent) 0%, rgba(232,111,51,0.75) 50%, var(--accent) 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }

    /* Session list hover accent bar */
    .session-item {
      position: relative;
    }

    .session-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 60%;
      background: var(--accent);
      border-radius: 0 2px 2px 0;
      transition: width 0.15s ease;
    }

    .session-item:hover::before {
      width: 0;
    }

    .sidebar-focused .session-item.active {
      background: transparent;
      border-color: transparent;
    }

    .sidebar-focused .session-item.active::before {
      width: 0;
    }

    .session-item.kb-selected,
    .session-item.kb-selected:hover,
    .session-item.active.kb-selected {
      background: var(--bg-elevated);
      border-color: var(--team);
      box-shadow: 0 0 0 1px var(--team-dim);
    }

    .session-item.kb-selected::before {
      width: 0;
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <header class="sidebar-header">
        <div class="logo">
          <div class="logo-mark">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <span class="logo-text">Dashboard</span>
        </div>
        <div id="connection-status" class="connection">
          <span class="connection-dot"></span>
          <span>Connecting</span>
        </div>
        <button id="sidebar-toggle" class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
      </header>

      <!-- Live Updates -->
      <div class="sidebar-section">
        <div class="section-header">
          <span>Live Updates</span>
        </div>
        <div id="live-updates" class="live-updates">
          <div class="live-empty">No active tasks</div>
        </div>
      </div>

      <!-- Tasks -->
      <div class="sidebar-section flex-1">
        <div class="section-header">
          <span>Sessions</span>
          <button onclick="showAllTasks()" style="background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 4px; padding: 3px 8px; font-size: 10px; color: var(--text-secondary); cursor: pointer; font-family: var(--mono);">All Tasks</button>
        </div>
        <div class="search-container">
          <input
            id="search-input"
            type="text"
            class="search-input"
            placeholder="Search tasks, sessions, projects..."
            oninput="handleSearch(this.value)"
          />
          <button id="search-clear-btn" class="search-clear" onclick="clearSearch()" title="Clear search" aria-label="Clear search">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="filter-row">
          <select id="project-filter" class="filter-dropdown" onchange="filterByProject(this.value)" aria-label="Filter by project">
            <option value="">All Projects</option>
          </select>
          <select id="session-filter" class="filter-dropdown" onchange="filterBySessions(this.value)" aria-label="Filter by session status">
            <option value="all">All Sessions</option>
            <option value="active">Active Only</option>
          </select>
        </div>
        <div class="filter-row">
          <select id="session-limit" class="filter-dropdown" onchange="changeSessionLimit(this.value)" aria-label="Number of sessions to show">
            <option value="10">Show 10</option>
            <option value="20">Show 20</option>
            <option value="50">Show 50</option>
            <option value="all">Show All</option>
          </select>
          <button class="icon-btn reset-btn" onclick="resetState()" title="Reset all filters" aria-label="Reset all filters">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path d="M3 12a9 9 0 1 1 9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M3 22v-6h6"/>
            </svg>
          </button>
        </div>
        <div id="sessions-list" class="sessions-list"></div>
      </div>

      <div class="sidebar-footer" id="sidebar-footer"></div>
      <div class="sidebar-resize-handle" id="sidebar-resize"></div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div id="no-session" class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <p>Select a session to view tasks</p>
      </div>

      <div id="session-view" class="session-view">
        <header class="view-header">
          <div>
            <h1 id="session-title" class="view-title">Session</h1>
            <p id="session-meta" class="view-meta"></p>
          </div>
          <div class="view-actions">
            <div class="view-progress">
              <div class="progress-bar">
                <div id="progress-bar" class="progress-fill" style="width: 0%"></div>
              </div>
              <span id="progress-percent" class="progress-text">0%</span>
            </div>
            <button id="theme-toggle" class="icon-btn" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle theme">
              <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
              </svg>
              <svg id="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                <circle cx="12" cy="12" r="5"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
              </svg>
            </button>
            <button class="icon-btn" onclick="showHelpModal()" title="Keyboard shortcuts (?)" aria-label="Keyboard shortcuts">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                <circle cx="12" cy="17" r="0.5" fill="currentColor"/>
              </svg>
            </button>
            <a href="https://github.com/NikiforovAll/claude-task-viewer" target="_blank" class="icon-btn" title="View on GitHub" aria-label="View on GitHub">
              <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
              </svg>
            </a>
          </div>
        </header>

        <div class="kanban" id="main-content">
          <div id="owner-filter-bar" class="owner-filter-bar">
            <select id="owner-filter" class="filter-dropdown" onchange="filterByOwner(this.value)" aria-label="Filter by team member">
              <option value="">All Members</option>
            </select>
          </div>
          <div class="kanban-column" aria-label="Pending tasks">
            <div class="column-header">
              <span class="column-dot pending"></span>
              <span class="column-title pending">Pending</span>
              <span id="pending-count" class="column-count pending">0</span>
            </div>
            <div id="pending-tasks" class="column-tasks" role="list"></div>
          </div>

          <div class="kanban-column" aria-label="In progress tasks">
            <div class="column-header">
              <span class="column-dot in-progress"></span>
              <span class="column-title in-progress">In Progress</span>
              <span id="in-progress-count" class="column-count in-progress">0</span>
            </div>
            <div id="in-progress-tasks" class="column-tasks" role="list"></div>
          </div>

          <div class="kanban-column" aria-label="Completed tasks">
            <div class="column-header">
              <span class="column-dot completed"></span>
              <span class="column-title completed">Completed</span>
              <span id="completed-count" class="column-count completed">0</span>
            </div>
            <div id="completed-tasks" class="column-tasks" role="list"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Detail panel -->
    <aside id="detail-panel" class="detail-panel">
      <header class="detail-header">
        <h3>Task Details</h3>
        <button id="close-detail" class="detail-close" aria-label="Close detail panel">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </header>
      <div id="detail-content" class="detail-content"></div>
    </aside>
  </div>

  <script>
    // State
    let sessions = [];
    let currentSessionId = null;
    let currentTasks = [];
    let viewMode = 'session';
    let sessionFilter = 'active';
    let sessionLimit = '20';
    let filterProject = null; // null = all projects, or project path to filter
    let searchQuery = ''; // Search query for fuzzy search
    let allTasksCache = []; // Cache all tasks for search
    let bulkDeleteSessionId = null; // Track session for bulk delete
    let ownerFilter = '';
    let selectedTaskId = null;
    let selectedSessionId = null;
    let focusZone = 'board'; // 'board' | 'sidebar'
    let selectedSessionIdx = -1;

    function getUrlState() {
      const params = new URLSearchParams(window.location.search);
      return {
        session: params.get('session'),
        view: params.get('view'),
        filter: params.get('filter'),
        limit: params.get('limit'),
        project: params.get('project'),
        owner: params.get('owner'),
        search: params.get('search'),
      };
    }

    function updateUrl() {
      const params = new URLSearchParams();
      if (viewMode === 'all') params.set('view', 'all');
      if (currentSessionId) params.set('session', currentSessionId);
      if (sessionFilter !== 'active') params.set('filter', sessionFilter);
      if (sessionLimit !== '20') params.set('limit', sessionLimit);
      if (filterProject) params.set('project', filterProject);
      if (ownerFilter) params.set('owner', ownerFilter);
      if (searchQuery) params.set('search', searchQuery);
      const qs = params.toString();
      const url = qs ? `?${qs}` : window.location.pathname;
      history.replaceState(null, '', url);
    }

    function resetState() {
      history.replaceState(null, '', window.location.pathname);
      sessionFilter = 'active';
      sessionLimit = '20';
      filterProject = null;
      ownerFilter = '';
      searchQuery = '';
      viewMode = 'all';
      currentSessionId = null;
      const searchInput = document.getElementById('search-input');
      if (searchInput) searchInput.value = '';
      document.getElementById('search-clear-btn')?.classList.remove('visible');
      loadPreferences();
      fetchSessions().then(() => showAllTasks());
    }

    // DOM
    const sessionsList = document.getElementById('sessions-list');
    const noSession = document.getElementById('no-session');
    const sessionView = document.getElementById('session-view');
    const sessionTitle = document.getElementById('session-title');
    const sessionMeta = document.getElementById('session-meta');
    const progressPercent = document.getElementById('progress-percent');
    const progressBar = document.getElementById('progress-bar');
    const pendingTasks = document.getElementById('pending-tasks');
    const inProgressTasks = document.getElementById('in-progress-tasks');
    const completedTasks = document.getElementById('completed-tasks');
    const pendingCount = document.getElementById('pending-count');
    const inProgressCount = document.getElementById('in-progress-count');
    const completedCount = document.getElementById('completed-count');
    const detailPanel = document.getElementById('detail-panel');
    const detailContent = document.getElementById('detail-content');
    const connectionStatus = document.getElementById('connection-status');
    const COLUMNS = [
      { el: pendingTasks },
      { el: inProgressTasks },
      { el: completedTasks },
    ];

    let lastSessionsHash = '';
    let lastTasksHash = '';

    async function fetchSessions() {
      console.log('[fetchSessions] Starting...');
      try {
        const res = await fetch(`/api/sessions?limit=${sessionLimit}`);
        const newSessions = await res.json();
        const tasksRes = await fetch('/api/tasks/all');
        const newTasks = await tasksRes.json();

        const sessionsHash = JSON.stringify(newSessions);
        const tasksHash = JSON.stringify(newTasks);
        if (sessionsHash === lastSessionsHash && tasksHash === lastTasksHash) {
          console.log('[fetchSessions] No changes, skipping render');
          return;
        }
        lastSessionsHash = sessionsHash;
        lastTasksHash = tasksHash;

        sessions = newSessions;
        allTasksCache = newTasks;
        console.log('[fetchSessions] Sessions loaded:', sessions.length);
        renderSessions();
        console.log('[fetchSessions] Render complete');
        fetchLiveUpdates();
      } catch (error) {
        console.error('Failed to fetch sessions:', error);
      }
    }

    function handleSearch(query) {
      searchQuery = query.toLowerCase().trim();

      // Show/hide clear button
      const clearBtn = document.getElementById('search-clear-btn');
      if (searchQuery) {
        clearBtn.classList.add('visible');
      } else {
        clearBtn.classList.remove('visible');
      }

      updateUrl();
      renderSessions();
    }

    function clearSearch() {
      const searchInput = document.getElementById('search-input');
      searchInput.value = '';
      searchQuery = '';
      document.getElementById('search-clear-btn').classList.remove('visible');
      updateUrl();
      renderSessions();
    }

    function deleteAllSessionTasks(sessionId) {
      const session = sessions.find(s => s.id === sessionId);
      if (!session) return;

      // When viewing a single session, currentTasks already contains only that session's tasks
      // When viewing "All Tasks", tasks have sessionId property, so we filter
      const sessionTasks = currentSessionId === sessionId
        ? currentTasks
        : currentTasks.filter(t => t.sessionId === sessionId);

      if (sessionTasks.length === 0) {
        alert('No tasks to delete in this session');
        return;
      }

      bulkDeleteSessionId = sessionId;

      const displayName = session.name || sessionId;
      const message = `Delete all ${sessionTasks.length} task(s) from session "${displayName}"?`;

      document.getElementById('delete-session-tasks-message').textContent = message;

      const modal = document.getElementById('delete-session-tasks-modal');
      modal.classList.add('visible');

      // Handle ESC key
      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeDeleteSessionTasksModal();
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function closeDeleteSessionTasksModal() {
      const modal = document.getElementById('delete-session-tasks-modal');
      modal.classList.remove('visible');
      bulkDeleteSessionId = null;
    }

    async function confirmDeleteSessionTasks() {
      if (!bulkDeleteSessionId) return;

      const sessionId = bulkDeleteSessionId;
      closeDeleteSessionTasksModal();

      // Get tasks to delete
      const sessionTasks = currentSessionId === sessionId
        ? currentTasks
        : currentTasks.filter(t => t.sessionId === sessionId);

      // Sort tasks by dependency order (blocked tasks first, then blockers)
      const sortedTasks = topologicalSort(sessionTasks);

      let successCount = 0;
      let failedCount = 0;
      const failedTasks = [];

      for (const task of sortedTasks) {
        try {
          const res = await fetch(`/api/tasks/${sessionId}/${task.id}`, {
            method: 'DELETE'
          });

          if (res.ok) {
            successCount++;
          } else {
            failedCount++;
            const error = await res.json();
            failedTasks.push({ id: task.id, subject: task.subject, error: error.error });
            console.error(`Failed to delete task ${task.id}:`, error);
          }
        } catch (error) {
          failedCount++;
          failedTasks.push({ id: task.id, subject: task.subject, error: 'Network error' });
          console.error(`Error deleting task ${task.id}:`, error);
        }
      }

      // Show result modal
      showDeleteResultModal(successCount, failedCount, failedTasks);

      // Close detail panel if open
      closeDetailPanel();

      // Refresh the view
      await refreshCurrentView();
    }

    // Topological sort for task deletion order
    function topologicalSort(tasks) {
      const result = [];
      const visited = new Set();
      const visiting = new Set();
      const taskMap = new Map(tasks.map(t => [t.id, t]));

      function visit(taskId) {
        if (visited.has(taskId)) return;
        if (visiting.has(taskId)) return; // Cycle - skip

        visiting.add(taskId);
        const task = taskMap.get(taskId);

        if (task && task.blocks && task.blocks.length > 0) {
          // Visit all tasks that this task blocks (dependencies first)
          for (const blockedId of task.blocks) {
            if (taskMap.has(blockedId)) {
              visit(blockedId);
            }
          }
        }

        visiting.delete(taskId);
        visited.add(taskId);
        if (task) result.push(task);
      }

      // Visit all tasks
      for (const task of tasks) {
        visit(task.id);
      }

      return result;
    }

    function showDeleteResultModal(successCount, failedCount, failedTasks) {
      const modal = document.getElementById('delete-result-modal');
      const messageEl = document.getElementById('delete-result-message');
      const detailsEl = document.getElementById('delete-result-details');

      if (failedCount === 0) {
        messageEl.textContent = `Successfully deleted all ${successCount} task(s).`;
        detailsEl.style.display = 'none';
      } else {
        messageEl.textContent = `Deleted ${successCount} task(s). Failed to delete ${failedCount} task(s).`;

        const failedList = failedTasks.map(t =>
          `<li><strong>${escapeHtml(t.subject)}</strong> (#${escapeHtml(t.id)}): ${escapeHtml(t.error)}</li>`
        ).join('');
        detailsEl.innerHTML = `<ul style="margin: 8px 0 0 0; padding-left: 20px;">${failedList}</ul>`;
        detailsEl.style.display = 'block';
      }

      modal.classList.add('visible');

      // Handle ESC key
      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeDeleteResultModal();
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function closeDeleteResultModal() {
      const modal = document.getElementById('delete-result-modal');
      modal.classList.remove('visible');
    }

    function fuzzyMatch(text, query) {
      if (!query) return true;
      if (!text) return false;

      text = text.toLowerCase();
      query = query.toLowerCase();

      // Prioritize exact substring match
      if (text.includes(query)) return true;

      // Split by common delimiters to search in individual words
      const words = text.split(/[\s\-_\/\.]+/);

      // Check if query matches start of any word
      for (const word of words) {
        if (word.startsWith(query)) return true;
      }

      // Check if any word contains the query
      for (const word of words) {
        if (word.includes(query)) return true;
      }

      return false;
    }

    async function fetchLiveUpdates() {
      try {
        const res = await fetch('/api/tasks/all');
        const allTasks = await res.json();
        let activeTasks = allTasks.filter(t => t.status === 'in_progress');
        if (filterProject) {
          activeTasks = activeTasks.filter(t => t.project === filterProject);
        }
        renderLiveUpdates(activeTasks);
      } catch (error) {
        console.error('Failed to fetch live updates:', error);
      }
    }

    function renderLiveUpdates(activeTasks) {
      const container = document.getElementById('live-updates');

      if (activeTasks.length === 0) {
        container.innerHTML = '<div class="live-empty">No active tasks</div>';
        return;
      }

      container.innerHTML = activeTasks.map(task => `
        <div class="live-item" onclick="openLiveTask('${task.sessionId}', '${task.id}')">
          <span class="pulse"></span>
          <div class="live-item-content">
            <div class="live-item-action" title="${escapeHtml(task.activeForm || task.subject)}">${escapeHtml(task.activeForm || task.subject)}</div>
            <div class="live-item-session" title="${escapeHtml(task.sessionName || task.sessionId)}">${escapeHtml(task.sessionName || task.sessionId)}</div>
          </div>
        </div>
      `).join('');
    }

    async function openLiveTask(sessionId, taskId) {
      await fetchTasks(sessionId);
      showTaskDetail(taskId, sessionId);
    }

    let lastCurrentTasksHash = '';

    async function fetchTasks(sessionId) {
      try {
        viewMode = 'session';
        const res = await fetch(`/api/sessions/${sessionId}`);

        let newTasks;
        if (res.ok) {
          newTasks = await res.json();
        } else if (res.status === 404) {
          newTasks = [];
        } else {
          throw new Error(`Failed to fetch tasks: ${res.status}`);
        }

        const hash = JSON.stringify(newTasks);
        if (sessionId === currentSessionId && hash === lastCurrentTasksHash) {
          console.log('[fetchTasks] No changes, skipping render');
          return;
        }
        lastCurrentTasksHash = hash;

        currentTasks = newTasks;
        currentSessionId = sessionId;
        ownerFilter = '';
        updateUrl();
        renderSession();
      } catch (error) {
        console.error('Failed to fetch tasks:', error);
        currentTasks = [];
        currentSessionId = sessionId;
        lastCurrentTasksHash = '';
        updateUrl();
        renderSession();
      }
    }

    async function showAllTasks() {
      try {
        viewMode = 'all';
        currentSessionId = null;
        ownerFilter = '';
        const res = await fetch('/api/tasks/all');
        let tasks = await res.json();
        if (filterProject) {
          tasks = tasks.filter(t => t.project === filterProject);
        }
        currentTasks = tasks;
        updateUrl();
        renderAllTasks();
        renderSessions();
      } catch (error) {
        console.error('Failed to fetch all tasks:', error);
      }
    }

    function renderAllTasks() {
      noSession.style.display = 'none';
      sessionView.classList.add('visible');
      document.getElementById('owner-filter-bar').classList.remove('visible');

      const totalTasks = currentTasks.length;
      const completed = currentTasks.filter(t => t.status === 'completed').length;
      const percent = totalTasks > 0 ? Math.round((completed / totalTasks) * 100) : 0;

      const projectName = filterProject ? filterProject.split('/').pop() : null;
      sessionTitle.textContent = filterProject ? `Tasks: ${projectName}` : 'All Tasks';
      sessionMeta.textContent = filterProject
        ? `${totalTasks} tasks in this project`
        : `${totalTasks} tasks across ${sessions.length} sessions`;
      progressPercent.textContent = `${percent}%`;
      progressBar.style.width = `${percent}%`;

      renderKanban();
    }

    function renderSessions() {
      // Update project dropdown
      updateProjectDropdown();

      let filteredSessions = sessions;
      if (sessionFilter === 'active') {
        filteredSessions = filteredSessions.filter(s => s.pending > 0 || s.inProgress > 0);
      }
      if (filterProject) {
        filteredSessions = filteredSessions.filter(s => s.project === filterProject);
      }

      // Apply search filter
      if (searchQuery) {
        filteredSessions = filteredSessions.filter(session => {
          // Search in session name and ID
          if (session.name && fuzzyMatch(session.name, searchQuery)) return true;
          if (session.id && fuzzyMatch(session.id, searchQuery)) return true;

          // Search in project path
          if (session.project && fuzzyMatch(session.project, searchQuery)) return true;

          // Search in description
          if (session.description && fuzzyMatch(session.description, searchQuery)) return true;

          // Search in tasks for this session
          const sessionTasks = allTasksCache.filter(t => t.sessionId === session.id);
          return sessionTasks.some(task =>
            (task.subject && fuzzyMatch(task.subject, searchQuery)) ||
            (task.description && fuzzyMatch(task.description, searchQuery)) ||
            (task.activeForm && fuzzyMatch(task.activeForm, searchQuery))
          );
        });
      }

      if (filteredSessions.length === 0) {
        let emptyMsg = 'No sessions found';
        let emptyHint = 'Tasks appear when you use Claude Code';

        if (searchQuery) {
          emptyMsg = `No results for "${searchQuery}"`;
          emptyHint = 'Try a different search term or clear the search';
        } else if (filterProject && sessionFilter === 'active') {
          emptyMsg = 'No active sessions for this project';
          emptyHint = 'Try "All Sessions" or "All Projects"';
        } else if (filterProject) {
          emptyMsg = 'No sessions for this project';
          emptyHint = 'Select "All Projects" to see all';
        } else if (sessionFilter === 'active') {
          emptyMsg = 'No active sessions';
          emptyHint = 'Select "All Sessions" to see all';
        }
        sessionsList.innerHTML = `
          <div style="padding: 24px 12px; text-align: center; color: var(--text-muted); font-size: 12px;">
            <p>${emptyMsg}</p>
            <p style="margin-top: 8px; font-size: 11px;">${emptyHint}</p>
          </div>
        `;
        return;
      }

      sessionsList.innerHTML = filteredSessions.map(session => {
        const total = session.taskCount;
        const percent = total > 0 ? Math.round((session.completed / total) * 100) : 0;
        const isActive = session.id === currentSessionId && viewMode === 'session';
        const hasInProgress = session.inProgress > 0;
        const sessionName = session.name || session.id;
        const projectName = session.project ? session.project.split('/').pop() : null;
        const primaryName = projectName || sessionName;
        const secondaryName = projectName ? sessionName : null;

        // Format git branch for display
        const gitBranch = session.gitBranch ? escapeHtml(session.gitBranch) : null;

        // Format timestamps for display
        const createdDisplay = session.createdAt ? formatDate(session.createdAt) : '';
        const modifiedDisplay = formatDate(session.modifiedAt);
        const timeDisplay = session.createdAt && createdDisplay !== modifiedDisplay
          ? `Created ${createdDisplay} Â· Modified ${modifiedDisplay}`
          : modifiedDisplay;

        // Build tooltip
        const tooltip = [timeDisplay, gitBranch ? `Branch: ${gitBranch}` : ''].filter(Boolean).join(' | ');

        const isTeam = session.isTeam;
        const memberCount = session.memberCount || 0;

        return `
          <button onclick="fetchTasks('${session.id}')" class="session-item ${isActive ? 'active' : ''}" title="${tooltip}">
            <div class="session-name">${escapeHtml(primaryName)}</div>
            ${secondaryName ? `<div class="session-secondary">${escapeHtml(secondaryName)}</div>` : ''}
            ${gitBranch ? `<div class="session-branch">${gitBranch}</div>` : ''}
            <div class="session-progress">
              <span class="session-indicators">
                ${isTeam ? `<span class="team-badge" title="${memberCount} team members"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>${memberCount}</span>` : ''}
                ${isTeam ? `<span class="team-info-btn" onclick="event.stopPropagation(); showTeamModalForSession('${session.id}')" title="View team info">â„¹</span>` : ''}
                ${hasInProgress ? '<span class="pulse"></span>' : ''}
              </span>
              <div class="progress-bar"><div class="progress-fill" style="width: ${percent}%"></div></div>
              <span class="progress-text">${session.completed}/${total}</span>
            </div>
            <div class="session-time">${formatDate(session.modifiedAt)}</div>
          </button>
        `;
      }).join('');

      const items = getSessionItems();
      const activeIdx = items.findIndex(el => el.classList.contains('active'));
      if (activeIdx >= 0) selectedSessionIdx = activeIdx;

      if (focusZone === 'sidebar' && selectedSessionIdx >= 0) {
        if (items.length > 0) {
          const clamped = Math.min(selectedSessionIdx, items.length - 1);
          selectedSessionIdx = clamped;
          items[clamped].classList.add('kb-selected');
        } else {
          selectedSessionIdx = -1;
        }
      }
    }

    function renderSession() {
      noSession.style.display = 'none';
      sessionView.classList.add('visible');

      const session = sessions.find(s => s.id === currentSessionId);
      if (!session) return;

      const displayName = session.name || currentSessionId;

      // Create header with delete button
      sessionTitle.innerHTML = `
        <span style="flex: 1;">${escapeHtml(displayName)}</span>
        <button class="icon-btn icon-btn-danger" onclick="deleteAllSessionTasks('${session.id}')" title="Delete all tasks in this session">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
        </button>
      `;

      // Build meta text with project path, branch, and description
      const projectName = session.project ? session.project.split('/').pop() : null;
      const metaParts = [`${currentTasks.length} tasks`];
      if (projectName) {
        metaParts.push(projectName);
      }
      if (session.gitBranch) {
        metaParts.push(session.gitBranch);
      }
      if (session.description) {
        metaParts.push(session.description);
      }
      metaParts.push(formatDate(session.modifiedAt));
      sessionMeta.textContent = metaParts.join(' Â· ');

      const completed = currentTasks.filter(t => t.status === 'completed').length;
      const percent = currentTasks.length > 0 ? Math.round((completed / currentTasks.length) * 100) : 0;

      progressPercent.textContent = `${percent}%`;
      progressBar.style.width = `${percent}%`;
      const hasInProgress = currentTasks.some(t => t.status === 'in_progress');
      progressBar.classList.toggle('shimmer', hasInProgress && percent < 100);

      updateOwnerFilter();
      renderKanban();
      renderSessions();
    }

    function renderTaskCard(task) {
      const isBlocked = task.blockedBy && task.blockedBy.length > 0;
      const taskId = viewMode === 'all' ? `${task.sessionId?.slice(0,4)}-${task.id}` : task.id;
      const sessionLabel = viewMode === 'all' && task.sessionName ? task.sessionName : null;
      const statusClass = task.status.replace('_', '-');
      const actualSessionId = task.sessionId || currentSessionId;

      return `
        <div
          role="listitem"
          tabindex="0"
          data-task-id="${task.id}"
          data-session-id="${actualSessionId}"
          onclick="showTaskDetail('${task.id}', '${actualSessionId}')"
          class="task-card ${statusClass} ${isBlocked ? 'blocked' : ''}"
          aria-label="${escapeHtml(task.subject)} â€” ${task.status.replace('_',' ')}">
          <div class="task-id">
            <span>#${taskId}</span>
            ${isBlocked ? '<span class="task-badge blocked">Blocked</span>' : ''}
            ${task.owner ? (() => { const c = getOwnerColor(task.owner); return `<span class="task-owner-badge" style="background:${c.bg};color:${c.color}">${escapeHtml(task.owner)}</span>`; })() : ''}
          </div>
          <div class="task-title">${escapeHtml(task.subject)}</div>
          ${sessionLabel ? `<div class="task-session">${escapeHtml(sessionLabel)}</div>` : ''}
          ${task.status === 'in_progress' && task.activeForm ? `<div class="task-active">${escapeHtml(task.activeForm)}</div>` : ''}
          ${isBlocked ? `<div class="task-blocked">Waiting on ${task.blockedBy.map(id => '#' + id).join(', ')}</div>` : ''}
          ${task.description ? `<div class="task-desc">${escapeHtml(task.description.split('\n')[0])}</div>` : ''}
        </div>
      `;
    }

    function renderKanban() {
      let filtered = currentTasks;
      if (ownerFilter) {
        filtered = filtered.filter(t => t.owner === ownerFilter);
      }
      const pending = filtered.filter(t => t.status === 'pending');
      const inProgress = filtered.filter(t => t.status === 'in_progress');
      const completed = filtered.filter(t => t.status === 'completed');

      pendingCount.textContent = pending.length;
      inProgressCount.textContent = inProgress.length;
      completedCount.textContent = completed.length;

      const emptyIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>`;

      pendingTasks.innerHTML = pending.length > 0
        ? pending.map(renderTaskCard).join('')
        : `<div class="column-empty">${emptyIcon}<div>No pending tasks</div></div>`;

      inProgressTasks.innerHTML = inProgress.length > 0
        ? inProgress.map(renderTaskCard).join('')
        : `<div class="column-empty">${emptyIcon}<div>No active tasks</div></div>`;

      completedTasks.innerHTML = completed.length > 0
        ? completed.map(renderTaskCard).join('')
        : `<div class="column-empty">${emptyIcon}<div>No completed tasks</div></div>`;

      if (selectedTaskId) {
        const card = document.querySelector(`.task-card[data-task-id="${selectedTaskId}"][data-session-id="${selectedSessionId}"]`)
          || document.querySelector(`.task-card[data-task-id="${selectedTaskId}"]`);
        if (card) {
          card.classList.add('selected');
        } else {
          selectedTaskId = null;
          selectedSessionId = null;
        }
      }
    }

    function selectTask(taskId, sessionId) {
      const prev = document.querySelector('.task-card.selected');
      if (prev) prev.classList.remove('selected');
      selectedTaskId = taskId;
      selectedSessionId = sessionId;
      if (!taskId) return;
      const card = document.querySelector(`.task-card[data-task-id="${taskId}"][data-session-id="${sessionId}"]`)
        || document.querySelector(`.task-card[data-task-id="${taskId}"]`);
      if (card) {
        card.classList.add('selected');
        card.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    function getSelectedCardInfo() {
      if (!selectedTaskId) return null;
      for (let ci = 0; ci < COLUMNS.length; ci++) {
        const cards = Array.from(COLUMNS[ci].el.querySelectorAll('.task-card'));
        for (let i = 0; i < cards.length; i++) {
          if (cards[i].dataset.taskId === selectedTaskId) {
            return { colIndex: ci, cardIndex: i, card: cards[i] };
          }
        }
      }
      return null;
    }

    function navigateVertical(direction) {
      const info = getSelectedCardInfo();
      if (!info) {
        for (const col of COLUMNS) {
          const cards = Array.from(col.el.querySelectorAll('.task-card'));
          if (cards.length > 0) {
            selectTask(cards[0].dataset.taskId, cards[0].dataset.sessionId);
            return;
          }
        }
        return;
      }
      const cards = Array.from(COLUMNS[info.colIndex].el.querySelectorAll('.task-card'));
      const newIndex = info.cardIndex + direction;
      if (newIndex >= 0 && newIndex < cards.length) {
        selectTask(cards[newIndex].dataset.taskId, cards[newIndex].dataset.sessionId);
      }
    }

    function navigateHorizontal(direction) {
      const info = getSelectedCardInfo();
      if (!info) {
        navigateVertical(1);
        return;
      }
      let newColIndex = info.colIndex + direction;
      while (newColIndex >= 0 && newColIndex < COLUMNS.length) {
        const cards = Array.from(COLUMNS[newColIndex].el.querySelectorAll('.task-card'));
        if (cards.length > 0) {
          const clampedIndex = Math.min(info.cardIndex, cards.length - 1);
          selectTask(cards[clampedIndex].dataset.taskId, cards[clampedIndex].dataset.sessionId);
          return;
        }
        newColIndex += direction;
      }
    }

    function getSessionItems() {
      return Array.from(sessionsList.querySelectorAll('.session-item'));
    }

    function selectSessionByIndex(idx) {
      const items = getSessionItems();
      if (items.length === 0) return;
      const prev = sessionsList.querySelector('.session-item.kb-selected');
      if (prev) prev.classList.remove('kb-selected');
      selectedSessionIdx = Math.max(0, Math.min(idx, items.length - 1));
      items[selectedSessionIdx].classList.add('kb-selected');
      items[selectedSessionIdx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }

    function navigateSession(direction) {
      const items = getSessionItems();
      if (items.length === 0) return;
      if (selectedSessionIdx < 0) {
        selectSessionByIndex(0);
        return;
      }
      const newIdx = selectedSessionIdx + direction;
      if (newIdx >= 0 && newIdx < items.length) {
        selectSessionByIndex(newIdx);
      }
    }

    function activateSelectedSession() {
      const items = getSessionItems();
      if (selectedSessionIdx >= 0 && selectedSessionIdx < items.length) {
        items[selectedSessionIdx].click();
      }
    }

    function setFocusZone(zone) {
      const sidebar = document.querySelector('.sidebar');
      // Clear all zone visuals
      sidebar.classList.remove('sidebar-focused');
      const prevSession = sessionsList.querySelector('.session-item.kb-selected');
      if (prevSession) prevSession.classList.remove('kb-selected');
      const selCard = document.querySelector('.task-card.selected');
      if (selCard) selCard.classList.remove('selected');

      focusZone = zone;
      if (zone === 'sidebar') {
        if (sidebar.classList.contains('collapsed')) {
          sidebar.classList.remove('collapsed');
          localStorage.setItem('sidebar-collapsed', false);
        }
        sidebar.classList.add('sidebar-focused');
        const items = getSessionItems();
        if (selectedSessionIdx < 0 && items.length > 0) {
          const activeIdx = items.findIndex(el => el.classList.contains('active'));
          selectSessionByIndex(activeIdx >= 0 ? activeIdx : 0);
        } else if (items.length > 0) {
          selectSessionByIndex(selectedSessionIdx);
        }
      } else {
        if (selectedTaskId) {
          const card = document.querySelector(`.task-card[data-task-id="${selectedTaskId}"][data-session-id="${selectedSessionId}"]`)
            || document.querySelector(`.task-card[data-task-id="${selectedTaskId}"]`);
          if (card) card.classList.add('selected');
        } else {
          navigateVertical(1);
        }
      }
    }

    function getAvailableTasksOptions(currentTaskId = null) {
      const pending = currentTasks.filter(t => t.status === 'pending' && t.id !== currentTaskId);
      const inProgress = currentTasks.filter(t => t.status === 'in_progress' && t.id !== currentTaskId);
      const completed = currentTasks.filter(t => t.status === 'completed' && t.id !== currentTaskId);

      // Build options grouped by status
      let options = '';

      if (pending.length > 0) {
        options += '<optgroup label="Pending">';
        pending.forEach((t, idx) => {
          options += `<option value="${t.id}">#${t.id} - ${escapeHtml(t.subject)}</option>`;
        });
        options += '</optgroup>';
      }

      if (inProgress.length > 0) {
        options += '<optgroup label="In Progress">';
        inProgress.forEach((t, idx) => {
          options += `<option value="${t.id}">#${t.id} - ${escapeHtml(t.subject)}</option>`;
        });
        options += '</optgroup>';
      }

      if (completed.length > 0) {
        options += '<optgroup label="Completed">';
        completed.forEach((t, idx) => {
          options += `<option value="${t.id}">#${t.id} - ${escapeHtml(t.subject)}</option>`;
        });
        options += '</optgroup>';
      }

      return options;
    }

    async function showTaskDetail(taskId, sessionId = null) {
      let task = currentTasks.find(t => t.id === taskId && (!sessionId || t.sessionId === sessionId));

      // If task not found in currentTasks, fetch it from the session
      if (!task && sessionId && sessionId !== 'undefined') {
        try {
          const res = await fetch(`/api/sessions/${sessionId}`);
          const tasks = await res.json();
          task = tasks.find(t => t.id === taskId);
          if (!task) return;
        } catch (error) {
          console.error('Failed to fetch task:', error);
          return;
        }
      }

      if (!task) return;

      const actualSid = task.sessionId || sessionId || currentSessionId;
      selectTask(taskId, actualSid);
      detailPanel.classList.add('visible');

      const statusLabels = {
        completed: '<span class="detail-status completed"><span class="dot"></span>Completed</span>',
        in_progress: '<span class="detail-status in_progress"><span class="dot"></span>In Progress</span>',
        pending: '<span class="detail-status pending"><span class="dot"></span>Pending</span>'
      };

      const isBlocked = task.blockedBy && task.blockedBy.length > 0;
      const actualSessionId = task.sessionId || sessionId || currentSessionId;

      detailContent.innerHTML = `
        <div class="detail-section">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div class="detail-label">Task #${task.id}</div>
              <h2 class="detail-title">${escapeHtml(task.subject)}</h2>
            </div>
            <div style="display: flex; gap: 8px;">
              <button id="delete-task-btn" class="icon-btn" title="Delete task (D)" aria-label="Delete task" style="color: #ef4444; border-color: #ef4444;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="detail-section" style="display: flex; gap: 12px; align-items: center;">
          <div>${statusLabels[task.status] || ''}</div>
          ${task.owner ? `<div style="font-size: 13px; color: ${getOwnerColor(task.owner).color}; font-weight: 500;">${escapeHtml(task.owner)}</div>` : ''}
          ${isBlocked && task.status !== 'in_progress' ? '<div style="font-size: 10px; color: var(--warning);">Blocked</div>' : ''}
        </div>

        <div class="detail-section">
          <div class="detail-label">Description</div>
          <div class="detail-desc">${task.description ? DOMPurify.sanitize(marked.parse(task.description)) : '<em style="color: var(--text-muted);">No description</em>'}</div>
        </div>

        ${task.activeForm && task.status === 'in_progress' ? `
          <div class="detail-section">
            <div class="detail-box active">
              <strong>Currently:</strong> ${escapeHtml(task.activeForm)}
            </div>
          </div>
        ` : ''}

        <div class="detail-section">
          <div class="detail-label">Blocked By</div>
          <div class="detail-desc">
            ${task.blockedBy && task.blockedBy.length > 0
              ? `<div class="detail-box blocked"><strong>Blocked by:</strong> ${task.blockedBy.map(id => '#' + id).join(', ')}</div>`
              : '<em style="color: var(--text-muted); font-size: 13px;">No dependencies</em>'}
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-label">Blocks</div>
          <div class="detail-desc">
            ${task.blocks && task.blocks.length > 0
              ? `<div class="detail-box blocks"><strong>Blocks:</strong> ${task.blocks.map(id => '#' + id).join(', ')}</div>`
              : '<em style="color: var(--text-muted); font-size: 13px;">No tasks blocked</em>'}
          </div>
        </div>

        <div class="detail-section note-section">
          <label for="note-input" class="detail-label">Add Note</label>
          <form class="note-form" onsubmit="addNote(event, '${task.id}', '${actualSessionId}')">
            <textarea id="note-input" class="note-input" placeholder="Add a note for Claude..." rows="3"></textarea>
            <button type="submit" class="note-submit">Add Note</button>
          </form>
        </div>
      `;

      // Setup button handlers
      document.getElementById('delete-task-btn').onclick = () => deleteTask(task.id, actualSessionId);
    }

    async function addNote(event, taskId, sessionId) {
      event.preventDefault();
      const input = document.getElementById('note-input');
      const note = input.value.trim();
      if (!note) return;

      try {
        const res = await fetch(`/api/tasks/${sessionId}/${taskId}/note`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note })
        });

        if (res.ok) {
          input.value = '';
          // Refresh to show updated description
          if (viewMode === 'all') {
            const tasksRes = await fetch('/api/tasks/all');
            currentTasks = await tasksRes.json();
          } else {
            await fetchTasks(sessionId);
          }
          showTaskDetail(taskId, sessionId);
        }
      } catch (error) {
        console.error('Failed to add note:', error);
      }
    }

    function closeDetailPanel() {
      detailPanel.classList.remove('visible');
    }

    let deleteTaskId = null;
    let deleteSessionId = null;

    function showBlockedTaskModal(task) {
      const messageDiv = document.getElementById('blocked-task-message');

      const blockedByList = task.blockedBy.map(id => {
        const blockingTask = currentTasks.find(t => t.id === id);
        if (blockingTask) {
          return `<li><strong>#${blockingTask.id}</strong> - ${escapeHtml(blockingTask.subject)}</li>`;
        }
        return `<li><strong>#${id}</strong></li>`;
      }).join('');

      messageDiv.innerHTML = `
        <p style="margin-bottom: 12px;">Task <strong>#${task.id}</strong> - ${escapeHtml(task.subject)} is currently blocked by:</p>
        <ul style="margin: 0 0 16px 20px; padding: 0;">${blockedByList}</ul>
        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
          Please resolve these dependencies before moving this task to <strong>In Progress</strong>.
        </p>
      `;

      const modal = document.getElementById('blocked-task-modal');
      modal.classList.add('visible');

      // Handle ESC key
      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeBlockedTaskModal();
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function closeBlockedTaskModal() {
      const modal = document.getElementById('blocked-task-modal');
      modal.classList.remove('visible');
    }

    function deleteTask(taskId, sessionId) {
      const task = currentTasks.find(t => t.id === taskId);
      if (!task) return;

      deleteTaskId = taskId;
      deleteSessionId = sessionId;

      const message = document.getElementById('delete-confirm-message');
      message.textContent = `Delete task "${task.subject}"? This cannot be undone.`;

      const modal = document.getElementById('delete-confirm-modal');
      modal.classList.add('visible');

      // Handle ESC key
      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeDeleteConfirmModal();
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function closeDeleteConfirmModal() {
      const modal = document.getElementById('delete-confirm-modal');
      modal.classList.remove('visible');
      deleteTaskId = null;
      deleteSessionId = null;
    }

    async function confirmDelete() {
      if (!deleteTaskId || !deleteSessionId) return;

      const taskId = deleteTaskId;
      const sessionId = deleteSessionId;

      closeDeleteConfirmModal();

      try {
        const res = await fetch(`/api/tasks/${sessionId}/${taskId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          closeDetailPanel();
          await refreshCurrentView();
        } else {
          const error = await res.json();
          alert('Failed to delete task: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Failed to delete task:', error);
        alert('Failed to delete task');
      }
    }

    function showHelpModal() {
      const modal = document.getElementById('help-modal');
      modal.classList.add('visible');

      // Handle keyboard shortcuts
      const keyHandler = (e) => {
        if (e.key === 'Escape' || e.key === '?') {
          e.preventDefault();
          closeHelpModal();
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function closeHelpModal() {
      const modal = document.getElementById('help-modal');
      modal.classList.remove('visible');
    }

    async function refreshCurrentView() {
      fetchLiveUpdates();
      if (viewMode === 'all') {
        await showAllTasks();
      } else if (currentSessionId) {
        await fetchTasks(currentSessionId);
      } else {
        await fetchSessions();
      }
    }

    document.getElementById('close-detail').onclick = closeDetailPanel;

    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
      }

      if (document.querySelector('.modal-overlay.visible')) return;

      if (e.key === '[') {
        e.preventDefault();
        toggleSidebar();
        return;
      }

      // Tab toggles focus zone
      if (e.key === 'Tab') {
        e.preventDefault();
        setFocusZone(focusZone === 'board' ? 'sidebar' : 'board');
        return;
      }

      // Sidebar navigation
      if (focusZone === 'sidebar') {
        if (e.key === 'j' || e.key === 'ArrowDown') {
          e.preventDefault();
          navigateSession(1);
          return;
        }
        if (e.key === 'k' || e.key === 'ArrowUp') {
          e.preventDefault();
          navigateSession(-1);
          return;
        }
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          activateSelectedSession();
          return;
        }
        if (e.key === 'Escape') {
          setFocusZone('board');
          return;
        }
        if (e.key === '?' || (e.key === '/' && e.shiftKey)) {
          e.preventDefault();
          showHelpModal();
        }
        return;
      }

      // Board navigation
      const navKeys = ['j','k','h','l','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'];
      if (navKeys.includes(e.key)) {
        e.preventDefault();
        if (e.key === 'j' || e.key === 'ArrowDown') navigateVertical(1);
        else if (e.key === 'k' || e.key === 'ArrowUp') navigateVertical(-1);
        else if (e.key === 'h' || e.key === 'ArrowLeft') navigateHorizontal(-1);
        else if (e.key === 'l' || e.key === 'ArrowRight') navigateHorizontal(1);

        if (selectedTaskId && detailPanel.classList.contains('visible')) {
          showTaskDetail(selectedTaskId, selectedSessionId);
        }
        return;
      }

      if ((e.key === 'Enter' || e.key === ' ') && selectedTaskId && e.target.tagName !== 'BUTTON') {
        e.preventDefault();
        if (detailPanel.classList.contains('visible')) {
          const labelEl = document.querySelector('.detail-label');
          const shownId = labelEl?.textContent.match(/\d+/)?.[0];
          if (shownId === selectedTaskId) {
            closeDetailPanel();
          } else {
            showTaskDetail(selectedTaskId, selectedSessionId);
          }
        } else {
          showTaskDetail(selectedTaskId, selectedSessionId);
        }
        return;
      }

      if (e.key === 'Escape' && detailPanel.classList.contains('visible')) {
        closeDetailPanel();
      }

      if (detailPanel.classList.contains('visible')) {
        const labelElement = document.querySelector('.detail-label');
        if (!labelElement) return;
        const taskId = labelElement.textContent.match(/\d+/)?.[0];
        if (!taskId) return;
        const task = currentTasks.find(t => t.id === taskId);
        if (!task) return;
        const sessionId = task.sessionId || currentSessionId;
        if (e.key === 'd' || e.key === 'D') {
          e.preventDefault();
          deleteTask(taskId, sessionId);
        }
      }

      if (e.key === '?' || (e.key === '/' && e.shiftKey)) {
        e.preventDefault();
        showHelpModal();
      }
    });

    function setupEventSource() {
      let retryDelay = 1000;
      let eventSource;

      function connect() {
        eventSource = new EventSource('/api/events');

        eventSource.onopen = () => {
          retryDelay = 1000; // Reset on successful connection
          connectionStatus.innerHTML = `
            <span class="connection-dot live"></span>
            <span>Connected</span>
          `;
        };

        eventSource.onerror = () => {
          eventSource.close();
          connectionStatus.innerHTML = `
            <span class="connection-dot error"></span>
            <span>Reconnecting...</span>
          `;
          setTimeout(connect, retryDelay);
          retryDelay = Math.min(retryDelay * 2, 30000); // Max 30s
        };

        let refreshTimer = null;
        function debouncedRefresh(sessionId, isMetadata) {
          clearTimeout(refreshTimer);
          const delay = isMetadata ? 2000 : 500;
          refreshTimer = setTimeout(() => {
            fetchSessions().catch(err => console.error('[SSE] fetchSessions failed:', err));
            if (currentSessionId && (isMetadata || sessionId === currentSessionId)) {
              fetchTasks(currentSessionId);
            }
          }, delay);
        }

        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log('[SSE] Event received:', data);
          if (data.type === 'update' || data.type === 'metadata-update') {
            debouncedRefresh(data.sessionId, data.type === 'metadata-update');
          }

          if (data.type === 'team-update') {
            console.log('[SSE] Team update:', data.teamName);
            debouncedRefresh(data.teamName, false);
            if (currentSessionId && data.teamName === currentSessionId) {
              fetchTasks(currentSessionId);
            }
          }
        };
      }

      connect();
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      return date.toLocaleDateString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    const ownerColors = [
      { bg: 'rgba(37, 99, 235, 0.14)',  color: '#1d5bbf' },  // blue
      { bg: 'rgba(168, 85, 247, 0.14)', color: '#7c3aed' },  // purple
      { bg: 'rgba(14, 165, 133, 0.14)', color: '#0d7d65' },  // teal
      { bg: 'rgba(220, 80, 30, 0.14)',  color: '#c04a1a' },  // red-orange
      { bg: 'rgba(202, 138, 4, 0.14)',  color: '#92700c' },   // amber
      { bg: 'rgba(219, 39, 119, 0.14)', color: '#b5246a' },  // pink
      { bg: 'rgba(22, 163, 74, 0.14)',  color: '#15803d' },   // green
      { bg: 'rgba(99, 102, 241, 0.14)', color: '#4f46e5' },  // indigo
    ];
    const ownerColorCache = {};
    function getOwnerColor(name) {
      if (ownerColorCache[name]) return ownerColorCache[name];
      let hash = 5381;
      for (let i = 0; i < name.length; i++) {
        hash = ((hash * 33) ^ name.charCodeAt(i)) | 0;
      }
      const c = ownerColors[Math.abs(hash) % ownerColors.length];
      ownerColorCache[name] = c;
      return c;
    }

    function filterBySessions(value) {
      sessionFilter = value;
      updateUrl();
      renderSessions();
    }

    function changeSessionLimit(value) {
      sessionLimit = value;
      updateUrl();
      fetchSessions();
    }

    function filterByProject(project) {
      filterProject = project || null;
      updateUrl();
      renderSessions();
      fetchLiveUpdates();
      showAllTasks();
    }

    function updateProjectDropdown() {
      const dropdown = document.getElementById('project-filter');
      const projects = [...new Set(sessions.map(s => s.project).filter(Boolean))].sort();

      dropdown.innerHTML = '<option value="">All Projects</option>' +
        projects.map(p => {
          const name = p.split('/').pop();
          const selected = p === filterProject ? ' selected' : '';
          return `<option value="${p}"${selected} title="${escapeHtml(p)}">${escapeHtml(name)}</option>`;
        }).join('');
    }

    function toggleTheme() {
      const isCurrentlyLight = document.body.classList.contains('light');
      if (isCurrentlyLight) {
        document.body.classList.remove('light');
        document.body.classList.add('dark-forced');
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.add('light');
        document.body.classList.remove('dark-forced');
        localStorage.setItem('theme', 'light');
      }
      updateThemeIcon();
    }

    function updateThemeIcon() {
      const saved = localStorage.getItem('theme');
      const isLight = document.body.classList.contains('light') ||
        (!saved && window.matchMedia('(prefers-color-scheme: light)').matches);
      document.getElementById('theme-icon-dark').style.display = isLight ? 'none' : 'block';
      document.getElementById('theme-icon-light').style.display = isLight ? 'block' : 'none';
    }

    function loadTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'light') {
        document.body.classList.add('light');
        document.body.classList.remove('dark-forced');
      } else if (saved === 'dark') {
        document.body.classList.remove('light');
        document.body.classList.add('dark-forced');
      }
      // If no saved preference, system prefers-color-scheme CSS handles it
      updateThemeIcon();
    }

    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const collapsed = sidebar.classList.toggle('collapsed');
      localStorage.setItem('sidebar-collapsed', collapsed);
    }

    function loadSidebarState() {
      const sidebar = document.querySelector('.sidebar');
      if (localStorage.getItem('sidebar-collapsed') === 'true') {
        sidebar.classList.add('collapsed');
      }
      const w = localStorage.getItem('sidebar-width');
      if (w) {
        sidebar.style.setProperty('--sidebar-width', w);
      }
    }

    function initSidebarResize() {
      const sidebar = document.querySelector('.sidebar');
      const handle = document.getElementById('sidebar-resize');
      let startX, startWidth;

      handle.addEventListener('mousedown', (e) => {
        if (sidebar.classList.contains('collapsed')) return;
        startX = e.clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
        handle.classList.add('dragging');
        document.body.style.userSelect = 'none';
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
        e.preventDefault();
      });

      function onMove(e) {
        const w = Math.min(600, Math.max(200, startWidth + e.clientX - startX));
        sidebar.style.setProperty('--sidebar-width', w + 'px');
        sidebar.style.width = w + 'px';
      }

      function onUp() {
        sidebar.classList.remove('resizing');
        handle.classList.remove('dragging');
        document.body.style.userSelect = '';
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        localStorage.setItem('sidebar-width', sidebar.style.getPropertyValue('--sidebar-width'));
      }
    }

    function loadPreferences() {
      document.getElementById('session-filter').value = sessionFilter;
      document.getElementById('session-limit').value = sessionLimit;
    }

    async function showTeamModalForSession(sessionId) {
      const session = sessions.find(s => s.id === sessionId);
      if (!session || !session.isTeam) return;
      try {
        const res = await fetch(`/api/teams/${sessionId}`);
        if (!res.ok) return;
        const teamConfig = await res.json();
        showTeamModal(teamConfig, currentSessionId === sessionId ? currentTasks : []);
      } catch (e) {
        console.error('Failed to fetch team config:', e);
      }
    }

    function showTeamModal(teamConfig, tasks) {
      const modal = document.getElementById('team-modal');
      const titleEl = document.getElementById('team-modal-title');
      const bodyEl = document.getElementById('team-modal-body');

      titleEl.textContent = `Team: ${teamConfig.team_name || teamConfig.name || 'Unknown'}`;

      const ownerCounts = {};
      tasks.forEach(t => {
        if (t.owner) {
          ownerCounts[t.owner] = (ownerCounts[t.owner] || 0) + 1;
        }
      });

      const members = teamConfig.members || [];
      const description = teamConfig.description || '';
      const lead = members.find(m => m.agentType === 'team-lead' || m.name === 'team-lead');

      let html = '';
      if (description) {
        html += `<div class="team-modal-desc">"${escapeHtml(description)}"</div>`;
      }

      html += `<div style="font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 10px;">Members (${members.length})</div>`;

      members.forEach(member => {
        const taskCount = ownerCounts[member.name] || 0;
        html += `
          <div class="team-member-card">
            <div class="member-name">ðŸŸ¢ ${escapeHtml(member.name)}</div>
            <div class="member-detail">Role: ${escapeHtml(member.agentType || 'unknown')}</div>
            ${member.model ? `<div class="member-detail">Model: ${escapeHtml(member.model)}</div>` : ''}
            <div class="member-tasks">Tasks: ${taskCount} assigned</div>
          </div>
        `;
      });

      const metaParts = [];
      if (teamConfig.created_at) {
        metaParts.push(`Created: ${new Date(teamConfig.created_at).toLocaleString()}`);
      }
      if (lead) {
        metaParts.push(`Lead: ${lead.name}`);
      }
      if (teamConfig.working_dir) {
        metaParts.push(`Working dir: ${teamConfig.working_dir}`);
      }
      if (metaParts.length > 0) {
        html += `<div class="team-modal-meta">${metaParts.map(p => escapeHtml(p)).join('<br>')}</div>`;
      }

      bodyEl.innerHTML = html;
      modal.classList.add('visible');

      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeTeamModal();
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function closeTeamModal() {
      document.getElementById('team-modal').classList.remove('visible');
    }

    function updateOwnerFilter() {
      const bar = document.getElementById('owner-filter-bar');
      const select = document.getElementById('owner-filter');

      const session = sessions.find(s => s.id === currentSessionId);
      if (!session || !session.isTeam) {
        bar.classList.remove('visible');
        return;
      }

      bar.classList.add('visible');
      const owners = [...new Set(currentTasks.map(t => t.owner).filter(Boolean))].sort();
      select.innerHTML = '<option value="">All Members</option>' +
        owners.map(o => {
          const c = getOwnerColor(o);
          return `<option value="${escapeHtml(o)}" style="color:${c.color};background:${c.bg}"${o === ownerFilter ? ' selected' : ''}>${escapeHtml(o)}</option>`;
        }).join('');
      const current = ownerFilter ? getOwnerColor(ownerFilter) : null;
      select.style.color = current ? current.color : '';
      select.style.backgroundColor = current ? current.bg : '';
    }

    function filterByOwner(value) {
      ownerFilter = value;
      const select = document.getElementById('owner-filter');
      const c = value ? getOwnerColor(value) : null;
      select.style.color = c ? c.color : '';
      select.style.backgroundColor = c ? c.bg : '';
      updateUrl();
      renderKanban();
    }

    // Sync sidebar header height with view header
    const sidebarHeader = document.querySelector('.sidebar-header');
    const viewHeader = document.querySelector('.view-header');
    new ResizeObserver(() => {
      sidebarHeader.style.height = viewHeader.offsetHeight + 'px';
    }).observe(viewHeader);

    // Init
    loadTheme();
    loadSidebarState();
    initSidebarResize();
    fetch('/api/version').then(r => r.json()).then(d => {
      document.getElementById('sidebar-footer').textContent = 'v' + d.version;
    }).catch(() => {});

    const urlState = getUrlState();
    sessionFilter = urlState.filter || 'active';
    sessionLimit = urlState.limit || '20';
    filterProject = urlState.project || null;
    ownerFilter = urlState.owner || '';
    searchQuery = urlState.search || '';

    loadPreferences();
    setupEventSource();

    if (urlState.search) {
      document.getElementById('search-input').value = urlState.search;
      document.getElementById('search-clear-btn').classList.add('visible');
    }

    fetchSessions().then(() => {
      if (urlState.session) {
        fetchTasks(urlState.session);
      } else {
        showAllTasks();
      }
    });

    window.addEventListener('popstate', () => {
      const s = getUrlState();
      sessionFilter = s.filter || 'active';
      sessionLimit = s.limit || '20';
      filterProject = s.project || null;
      ownerFilter = s.owner || '';
      searchQuery = s.search || '';
      loadPreferences();
      if (s.session) fetchTasks(s.session);
      else showAllTasks();
    });
  </script>

  <!-- Help Modal -->
  <div id="help-modal" class="modal-overlay" onclick="closeHelpModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Keyboard Shortcuts</h3>
        <button class="modal-close" aria-label="Close dialog" onclick="closeHelpModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div style="display: grid; gap: 16px;">
          <div>
            <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px; font-weight: 600;">Global</h4>
            <table style="width: 100%; font-size: 13px;">
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">?</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Show keyboard shortcuts</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">Esc</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Close panels or cancel</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">Tab</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Toggle sidebar / board focus</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">[</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Toggle sidebar collapse</td>
              </tr>
            </table>
          </div>
          <div>
            <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px; font-weight: 600;">Navigation</h4>
            <table style="width: 100%; font-size: 13px;">
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">J</kbd> / <kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">&darr;</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Next task in column</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">K</kbd> / <kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">&uarr;</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Previous task in column</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">H</kbd> / <kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">&larr;</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Move to left column</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">L</kbd> / <kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">&rarr;</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Move to right column</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">Enter</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Toggle task detail panel</td>
              </tr>
            </table>
          </div>
          <div>
            <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px; font-weight: 600;">Task Actions</h4>
            <table style="width: 100%; font-size: 13px;">
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">D</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Delete selected task</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeHelpModal()">Got it</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-confirm-modal" class="modal-overlay" onclick="closeDeleteConfirmModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Delete Task</h3>
        <button class="modal-close" aria-label="Close dialog" onclick="closeDeleteConfirmModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="delete-confirm-message" style="margin: 0; color: var(--text-primary);"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeleteConfirmModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmDelete()" style="background: #ef4444; border-color: #ef4444;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Delete All Session Tasks Confirmation Modal -->
  <div id="delete-session-tasks-modal" class="modal-overlay" onclick="closeDeleteSessionTasksModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">Delete All Tasks</h3>
        <button class="modal-close" aria-label="Close dialog" onclick="closeDeleteSessionTasksModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="delete-session-tasks-message" style="margin: 0 0 12px 0; color: var(--text-primary);"></p>
        <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeleteSessionTasksModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmDeleteSessionTasks()" style="background: #ef4444; border-color: #ef4444;">Delete All</button>
      </div>
    </div>
  </div>

  <!-- Delete Result Modal -->
  <div id="delete-result-modal" class="modal-overlay" onclick="closeDeleteResultModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">Deletion Result</h3>
        <button class="modal-close" aria-label="Close dialog" onclick="closeDeleteResultModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="delete-result-message" style="margin: 0; color: var(--text-primary);"></p>
        <div id="delete-result-details" style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeDeleteResultModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Team Info Modal -->
  <div id="team-modal" class="modal-overlay" onclick="closeTeamModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 520px; max-height: 80vh; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h3 id="team-modal-title" class="modal-title">Team</h3>
        <button class="modal-close" aria-label="Close dialog" onclick="closeTeamModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="team-modal-body" class="modal-body" style="overflow-y: auto; flex: 1;"></div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeTeamModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Blocked Task Warning Modal -->
  <div id="blocked-task-modal" class="modal-overlay" onclick="closeBlockedTaskModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
      <div class="modal-header">
        <h3 class="modal-title" style="display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="width: 20px; height: 20px;">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          Cannot Start Blocked Task
        </h3>
        <button class="modal-close" aria-label="Close dialog" onclick="closeBlockedTaskModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="blocked-task-message" style="color: var(--text-primary); line-height: 1.6;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeBlockedTaskModal()">OK</button>
      </div>
    </div>
  </div>
</body>
</html>
